<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PeytoToria</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts & Material Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        yt: {
                            base: '#030303',
                            sidebar: '#030303',
                            hover: '#1f1f1f',
                            text: '#ffffff',
                            textSec: '#aaaaaa',
                            red: '#ff0000',
                            accent: '#ffffff',
                            player: '#212121' 
                        }
                    },
                    fontFamily: {
                        sans: ['Roboto', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'explode': 'explode 0.6s ease-out forwards',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.2, 0.0, 0, 1.0) forwards',
                        'slide-down': 'slideDown 0.3s cubic-bezier(0.2, 0.0, 0, 1.0) forwards',
                        'thumb-pop': 'thumbPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        explode: {
                            '0%': { transform: 'scale(1)', opacity: '1' },
                            '50%': { transform: 'scale(1.5)', opacity: '0.8' },
                            '100%': { transform: 'scale(2)', opacity: '0' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(0)', opacity: '1' },
                            '100%': { transform: 'translateY(100%)', opacity: '0' }
                        },
                        thumbPop: {
                            '0%': { transform: 'scale(1) rotate(0deg)' },
                            '50%': { transform: 'scale(1.5) rotate(-15deg)' },
                            '100%': { transform: 'scale(1) rotate(0deg)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #030303;
            color: white;
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #030303; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4d4d4d; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #717171; 
        }

        .yt-btn {
            background: rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        .yt-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .artist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 24px;
        }
        
        @media (max-width: 768px) {
            .artist-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 16px;
            }
        }

        .discography-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 24px;
        }

        @media (max-width: 768px) {
            .discography-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 16px;
            }
        }

        /* Modal Animation */
        .modal {
            transition: opacity 0.25s ease;
            pointer-events: none;
            opacity: 0;
            backdrop-filter: blur(5px);
        }
        .modal.active {
            pointer-events: auto;
            opacity: 1;
        }
        .modal-content {
            transform: scale(0.95) translateY(20px);
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal.active .modal-content {
            transform: scale(1) translateY(0);
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Button Explode Effect */
        .icon-explode {
            position: relative;
        }
        .icon-explode::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            pointer-events: none;
        }
        .icon-explode.animating::after {
            animation: ripple 0.6s ease-out;
        }

        @keyframes ripple {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0.5; }
            100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; }
        }
        
        /* Mobile Nav */
        .mobile-nav-item.active {
            color: white;
        }
        .mobile-nav-item.active span {
            color: white;
        }
        .mobile-nav-item {
            color: #aaaaaa;
        }

        /* Sidebar Transition */
        aside {
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        aside.collapsed {
            width: 72px;
        }
        aside.collapsed .nav-text {
            display: none;
        }
        aside.collapsed .nav-btn {
            justify-content: center;
            padding-left: 0;
            padding-right: 0;
        }

        /* File Input Styling */
        input[type="file"]::file-selector-button {
            border: none;
            background: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 10px;
        }
        input[type="file"]::file-selector-button:hover {
            background: #444;
        }

        /* Toast positioning classes */
        .toast-hidden {
            transform: translateY(-150%); /* Move up for mobile */
        }
        @media (min-width: 768px) {
            .toast-hidden {
                transform: translateY(150%); /* Move down for desktop */
            }
        }
        
        /* Player Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            margin-top: -4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #4d4d4d;
            border-radius: 2px;
        }
        input[type=range]:hover::-webkit-slider-thumb {
            transform: scale(1.2);
        }

        /* Search Bar Animation */
        .search-container {
            transition: all 0.3s ease;
        }
        .search-container:focus-within {
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
            background-color: #121212;
            border-color: #444;
            flex-grow: 1.5;
        }
        .search-input {
            transition: width 0.3s ease;
        }

        /* Subscribe Thumbs Up Animation */
        .animate-thumb {
            animation: thumbPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
    </style>
</head>
<body class="h-screen flex flex-col bg-yt-base text-white">

    <!-- Desktop Top Navigation -->
    <nav class="h-16 flex items-center px-4 justify-between border-b border-[#1f1f1f] bg-[#030303] z-50 shrink-0">
        <div class="flex items-center gap-4">
            <button onclick="toggleSidebar()" class="p-2 rounded-full hover:bg-yt-hover hidden md:block icon-explode"><span class="material-icons-round text-white">menu</span></button>
            <div class="flex items-center gap-1 cursor-pointer" onclick="renderHome()">
                <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center">
                    <span class="material-icons-round text-yt-base text-xl">play_circle_filled</span>
                </div>
                <span class="text-xl font-bold tracking-tight hidden md:block">PeytoToria</span>
            </div>
        </div>

        <!-- Search Bar with Animation -->
        <div class="flex flex-1 max-w-xl mx-4 transition-all duration-300 ease-in-out">
            <div class="search-container bg-[#212121] flex items-center w-full px-4 py-2 rounded-lg border border-[#303030] transition-all duration-300">
                <span class="material-icons-round text-yt-textSec">search</span>
                <input type="text" id="search-input" placeholder="Search artists, songs..." class="bg-transparent border-none outline-none text-white ml-2 w-full placeholder-gray-500" oninput="handleSearch(this.value)">
            </div>
        </div>

        <div class="flex items-center gap-4">
            <!-- Time Skip Buttons -->
            <button onclick="skipTime(1)" class="hidden md:flex bg-white text-black px-3 py-1.5 rounded-full text-xs font-bold hover:bg-gray-200 transition items-center gap-1">
                <span class="material-icons-round text-sm">fast_forward</span> Next Day
            </button>
            <button onclick="skipTime(7)" class="hidden md:flex bg-[#212121] border border-[#333] text-white px-3 py-1.5 rounded-full text-xs font-bold hover:bg-[#333] transition items-center gap-1">
                <span class="material-icons-round text-sm">calendar_view_week</span> Next Week
            </button>

            <!-- Save/Load Controls -->
            <div class="relative group">
                <button class="w-8 h-8 rounded-full hover:bg-[#1f1f1f] flex items-center justify-center">
                    <span class="material-icons-round text-yt-textSec">save</span>
                </button>
                <div class="absolute right-0 top-full mt-2 w-48 bg-[#212121] rounded shadow-xl border border-[#333] hidden group-hover:block z-[60]">
                    <button onclick="downloadSave()" class="w-full text-left px-4 py-2 hover:bg-[#333] text-sm">Download Save</button>
                    <label class="w-full text-left px-4 py-2 hover:bg-[#333] text-sm block cursor-pointer">
                        Load Save
                        <input type="file" onchange="uploadSave(this)" class="hidden" accept=".json">
                    </label>
                    <button onclick="resetData()" class="w-full text-left px-4 py-2 hover:bg-[#333] text-sm text-red-500">Reset All Data</button>
                </div>
            </div>

            <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-500 to-blue-500 text-white flex items-center justify-center font-bold text-sm shadow-lg">U</div>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden relative">
        <!-- Sidebar (Desktop) -->
        <aside id="sidebar" class="w-64 bg-[#030303] hidden md:flex flex-col p-2 overflow-y-auto border-r border-[#1f1f1f] shrink-0">
            <div class="flex flex-col gap-1">
                <button onclick="animateNav('nav-home', renderHome)" class="nav-btn flex items-center gap-4 px-4 py-3 rounded-lg hover:bg-[#1f1f1f] text-white font-medium transition icon-explode" id="nav-home">
                    <span class="material-icons-round">home</span> <span class="nav-text">Home</span>
                </button>
                <button onclick="animateNav('nav-explore', renderExplore)" class="nav-btn flex items-center gap-4 px-4 py-3 rounded-lg text-yt-textSec hover:text-white hover:bg-[#1f1f1f] font-medium transition icon-explode" id="nav-explore">
                    <span class="material-icons-round">explore</span> <span class="nav-text">Explore</span>
                </button>
                <button onclick="animateNav('nav-charts', renderCharts)" class="nav-btn flex items-center gap-4 px-4 py-3 rounded-lg text-yt-textSec hover:text-white hover:bg-[#1f1f1f] font-medium transition icon-explode" id="nav-charts">
                    <span class="material-icons-round">leaderboard</span> <span class="nav-text">Charts</span>
                </button>
                <button onclick="animateNav('nav-library', renderLibrary)" class="nav-btn flex items-center gap-4 px-4 py-3 rounded-lg text-yt-textSec hover:text-white hover:bg-[#1f1f1f] font-medium transition icon-explode" id="nav-library">
                    <span class="material-icons-round">library_music</span> <span class="nav-text">Library</span>
                </button>
                <div class="border-t border-[#1f1f1f] my-2"></div>
                <button onclick="openModal('create-artist-modal')" class="nav-btn flex items-center gap-4 px-4 py-3 rounded-lg text-yt-textSec hover:text-white hover:bg-[#1f1f1f] font-medium transition icon-explode">
                    <span class="material-icons-round">add_circle_outline</span> <span class="nav-text">New Artist</span>
                </button>
            </div>
            
            <div class="mt-6 px-4 nav-text">
                <h3 class="text-xs uppercase font-bold text-yt-textSec mb-3">Your Artists</h3>
                <div id="sidebar-artist-list" class="flex flex-col gap-1">
                    <!-- Populated by JS -->
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-1 overflow-y-auto p-4 md:p-8 relative pb-32 md:pb-8">
            <!-- Content Injected Here -->
        </main>
    </div>

    <!-- Mobile Bottom Navigation -->
    <div class="md:hidden fixed bottom-0 left-0 right-0 h-16 bg-[#212121] border-t border-[#333] flex justify-around items-center z-50 pb-safe">
        <button onclick="animateNav('mob-nav-home', renderHome)" class="mobile-nav-item flex flex-col items-center gap-1 p-2 active icon-explode" id="mob-nav-home">
            <span class="material-icons-round">home</span>
            <span class="text-[10px]">Home</span>
        </button>
        <button onclick="animateNav('mob-nav-explore', renderExplore)" class="mobile-nav-item flex flex-col items-center gap-1 p-2 icon-explode" id="mob-nav-explore">
            <span class="material-icons-round">explore</span>
            <span class="text-[10px]">Explore</span>
        </button>
        <button onclick="animateNav('mob-nav-charts', renderCharts)" class="mobile-nav-item flex flex-col items-center gap-1 p-2 icon-explode" id="mob-nav-charts">
            <span class="material-icons-round">leaderboard</span>
            <span class="text-[10px]">Charts</span>
        </button>
        <button onclick="animateNav('mob-nav-library', renderLibrary)" class="mobile-nav-item flex flex-col items-center gap-1 p-2 icon-explode" id="mob-nav-library">
            <span class="material-icons-round">library_music</span>
            <span class="text-[10px]">Library</span>
        </button>
        <button onclick="animateNav('mob-nav-create', () => openModal('create-artist-modal'))" class="mobile-nav-item flex flex-col items-center gap-1 p-2 icon-explode" id="mob-nav-create">
            <span class="material-icons-round">add_circle_outline</span>
            <span class="text-[10px]">New Artist</span>
        </button>
    </div>

    <!-- Mobile Time Skips (Bottom Right Floating) -->
    <div class="md:hidden fixed bottom-20 right-4 flex flex-col gap-2 z-40">
        <button onclick="skipTime(1)" class="w-12 h-12 rounded-full bg-white text-black flex items-center justify-center shadow-xl">
            <span class="material-icons-round">fast_forward</span>
        </button>
        <button onclick="skipTime(7)" class="w-12 h-12 rounded-full bg-[#212121] border border-[#333] text-white flex items-center justify-center shadow-xl">
            <span class="material-icons-round">calendar_view_week</span>
        </button>
    </div>

    <!-- FULL SCREEN PLAYER -->
    <div id="music-player" class="fixed inset-0 z-[100] bg-[#030303] hidden flex flex-col h-[100dvh]">
        <!-- Background Gradient -->
        <div id="player-bg-gradient" class="absolute inset-0 bg-gradient-to-b from-[#1a1a1a] to-black opacity-95 pointer-events-none"></div>
        
        <!-- Top Bar -->
        <div class="relative z-10 flex items-center justify-between p-4 shrink-0">
            <button onclick="closePlayer()" class="p-2 text-white hover:bg-white/10 rounded-full transition"><span class="material-icons-round text-3xl">keyboard_arrow_down</span></button>
            <div class="text-xs uppercase tracking-widest text-gray-400 font-bold">Now Playing</div>
            <button class="p-2 text-white hover:bg-white/10 rounded-full transition"><span class="material-icons-round text-2xl">more_vert</span></button>
        </div>

        <!-- Main Content (Centered and responsive) -->
        <div class="relative z-10 flex-1 flex flex-col items-center justify-center w-full px-6 pb-8 overflow-hidden">
            
            <!-- Art Container (Responsive sizing - shrinks if needed) -->
            <div class="relative w-full max-w-sm md:max-w-md aspect-square shadow-2xl rounded-xl overflow-hidden mb-6 md:mb-10 flex-shrink min-h-0">
                <img id="player-img" src="" class="w-full h-full object-cover">
            </div>

            <!-- Metadata & Actions Row -->
            <div class="w-full max-w-2xl flex items-center justify-between mb-2 shrink-0">
                <div class="flex flex-col min-w-0 pr-4">
                    <h2 id="player-title" class="text-2xl md:text-3xl font-bold text-white truncate leading-tight">Song Title</h2>
                    <p id="player-artist" class="text-lg text-gray-400 truncate">Artist Name</p>
                </div>
                <!-- Like/Dislike Actions -->
                <div class="flex items-center gap-4 flex-shrink-0">
                     <button class="text-gray-400 hover:text-white transition"><span class="material-icons-round text-2xl">thumb_down</span></button>
                     <div class="flex flex-col items-center">
                        <button class="text-white hover:text-gray-200 transition"><span class="material-icons-round text-2xl">thumb_up</span></button>
                        <span id="player-likes" class="text-[10px] text-gray-400 font-medium mt-0.5">0</span>
                    </div>
                </div>
            </div>

             <!-- View Count (Subtle) -->
             <div class="w-full max-w-2xl text-xs text-gray-500 mb-6 flex items-center gap-1 shrink-0">
                <span id="player-views">0</span> views
             </div>

            <!-- Progress Bar -->
            <div class="w-full max-w-2xl mb-4 shrink-0 group">
                <input type="range" id="player-seek" value="0" min="0" max="100" class="w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer hover:h-1.5 transition-all accent-white">
                <div class="flex justify-between text-xs text-gray-400 mt-2 font-medium">
                    <span id="player-time-current">0:00</span>
                    <span id="player-time-total">0:00</span>
                </div>
            </div>

            <!-- Main Controls -->
            <div class="w-full max-w-2xl flex items-center justify-between shrink-0 px-2 md:px-8">
                <button class="text-gray-400 hover:text-white transition"><span class="material-icons-round text-2xl">shuffle</span></button>
                
                <div class="flex items-center gap-6 md:gap-10">
                    <button id="player-prev" class="text-white hover:text-gray-300 transition active:scale-90"><span class="material-icons-round text-4xl md:text-5xl">skip_previous</span></button>
                    
                    <button id="player-play-btn" onclick="togglePlay()" class="w-16 h-16 md:w-20 md:h-20 bg-white text-black rounded-full flex items-center justify-center hover:scale-105 transition shadow-lg active:scale-95">
                        <span class="material-icons-round text-4xl md:text-5xl" id="player-play-icon">play_arrow</span>
                    </button>
                    
                    <button id="player-next" class="text-white hover:text-gray-300 transition active:scale-90"><span class="material-icons-round text-4xl md:text-5xl">skip_next</span></button>
                </div>
                
                <button class="text-gray-400 hover:text-white transition"><span class="material-icons-round text-2xl">repeat</span></button>
            </div>
        </div>

        <!-- Hidden Audio Element -->
        <audio id="audio-element"></audio>
        <input type="file" id="mp3-upload" accept="audio/*" class="hidden">
    </div>

    <!-- Offline Report Toast -->
    <div id="offline-toast" class="fixed top-20 md:top-auto md:bottom-8 left-4 right-4 md:left-auto md:right-4 bg-white text-black px-6 py-4 rounded-lg shadow-2xl transition-transform duration-500 z-[90] max-w-sm toast-hidden flex flex-col">
        <div class="flex justify-between items-start mb-2">
            <h4 class="font-bold text-lg">Welcome Back!</h4>
            <button onclick="closeOfflineToast()" class="text-gray-500 hover:text-black p-1 -mr-2 -mt-2">
                <span class="material-icons-round">close</span>
            </button>
        </div>
        <p class="text-sm text-gray-700 mb-3" id="offline-report-text">You gained views while away.</p>
        <button onclick="closeOfflineToast()" class="bg-black text-white px-4 py-2 rounded text-xs font-bold uppercase tracking-wider self-end">Dismiss</button>
    </div>

    <!-- MODALS -->

    <!-- Create Artist Modal -->
    <div id="create-artist-modal" class="modal fixed inset-0 z-[80] bg-black/80 flex items-center justify-center p-4">
        <div class="modal-content bg-[#212121] w-full max-w-md rounded-xl shadow-2xl overflow-hidden border border-[#333]">
            <div class="p-4 border-b border-[#333] flex justify-between items-center">
                <h2 class="text-xl font-bold">Create Artist</h2>
                <button onclick="closeModal('create-artist-modal')" class="text-gray-400 hover:text-white"><span class="material-icons-round">close</span></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Artist Name</label>
                    <input type="text" id="new-artist-name" class="w-full bg-[#121212] border border-[#333] rounded p-2 text-white focus:border-white outline-none">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Profile Image</label>
                    <input type="text" id="new-artist-pfp" placeholder="Image URL (optional)" class="w-full bg-[#121212] border border-[#333] rounded p-2 text-white focus:border-white outline-none mb-2">
                    <div class="text-center text-xs text-gray-500 mb-2">- OR Upload -</div>
                    <input type="file" id="new-artist-pfp-file" accept="image/*" class="w-full text-xs text-gray-400">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Bio</label>
                    <textarea id="new-artist-bio" rows="3" class="w-full bg-[#121212] border border-[#333] rounded p-2 text-white focus:border-white outline-none"></textarea>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Pronouns</label>
                    <input type="text" id="new-artist-pronouns" placeholder="e.g. He/Him" class="w-full bg-[#121212] border border-[#333] rounded p-2 text-white focus:border-white outline-none">
                </div>
                <button onclick="createArtist()" class="w-full bg-white text-black font-bold py-2 rounded-full hover:bg-gray-200 mt-2">Create Profile</button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="modal fixed inset-0 z-[80] bg-black/80 flex items-center justify-center p-4">
        <div class="modal-content bg-[#212121] w-full max-w-lg rounded-xl shadow-2xl overflow-hidden border border-[#333]">
            <div class="p-4 border-b border-[#333] flex justify-between items-center">
                <h2 class="text-xl font-bold">Edit Profile</h2>
                <button onclick="closeModal('edit-profile-modal')" class="text-gray-400 hover:text-white"><span class="material-icons-round">close</span></button>
            </div>
            <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                <input type="hidden" id="edit-artist-id">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Name</label>
                        <input type="text" id="edit-artist-name" class="w-full bg-[#121212] border border-[#333] rounded p-2 text-white focus:border-white outline-none">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Subscribers</label>
                        <input type="number" id="edit-artist-subs" class="w-full bg-[#121212] border border-[#333] rounded p-2 text-white focus:border-white outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-xs text-gray-400 mb-1">Monthly Listeners Estimate</label>
                    <input type="number" id="edit-artist-monthly" class="w-full bg-[#121212] border border-[#333] rounded p-2 text-white focus:border-white outline-none">
                </div>

                <div>
                    <label class="block text-xs text-gray-400 mb-1">Profile Picture</label>
                    <input type="text" id="edit-artist-pfp" placeholder="Image URL" class="w-full bg-[#121212] border border-[#333] rounded p-2 text-white focus:border-white outline-none mb-2">
                    <input type="file" id="edit-artist-pfp-file" accept="image/*" class="w-full text-xs text-gray-400">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Banner Image</label>
                    <input type="text" id="edit-artist-banner" placeholder="Image URL" class="w-full bg-[#121212] border border-[#333] rounded p-2 text-white focus:border-white outline-none mb-2">
                    <input type="file" id="edit-artist-banner-file" accept="image/*" class="w-full text-xs text-gray-400">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Pronouns</label>
                    <input type="text" id="edit-artist-pronouns" class="w-full bg-[#121212] border border-[#333] rounded p-2 text-white focus:border-white outline-none">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Bio</label>
                    <textarea id="edit-artist-bio" rows="4" class="w-full bg-[#121212] border border-[#333] rounded p-2 text-white focus:border-white outline-none"></textarea>
                </div>
                <button onclick="saveArtistProfile()" class="w-full bg-white text-black font-bold py-2 rounded-full hover:bg-gray-200 mt-2">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Release Music Modal -->
    <div id="release-music-modal" class="modal fixed inset-0 z-[80] bg-black/80 flex items-center justify-center p-4">
        <div class="modal-content bg-[#212121] w-full max-w-md rounded-xl shadow-2xl overflow-hidden border border-[#333]">
            <div class="p-4 border-b border-[#333] flex justify-between items-center">
                <h2 class="text-xl font-bold">Release Music</h2>
                <button onclick="closeModal('release-music-modal')" class="text-gray-400 hover:text-white"><span class="material-icons-round">close</span></button>
            </div>
            <div class="p-6 space-y-4 max-h-[80vh] overflow-y-auto">
                <input type="hidden" id="release-artist-id">
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Title (Single or Album Name)</label>
                    <input type="text" id="release-title" class="w-full bg-[#121212] border border-[#333] rounded p-2 text-white focus:border-white outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Type</label>
                        <select id="release-type" class="w-full bg-[#121212] border border-[#333] rounded p-2 text-white focus:border-white outline-none">
                            <option value="Single">Single</option>
                            <option value="Album">Album</option>
                            <option value="EP">EP</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Track Count</label>
                        <input type="number" id="release-tracks" value="1" min="1" max="50" class="w-full bg-[#121212] border border-[#333] rounded p-2 text-white focus:border-white outline-none">
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Featured Artist 1</label>
                    <select id="release-feature-1" class="w-full bg-[#121212] border border-[#333] rounded p-2 text-white focus:border-white outline-none mb-2">
                        <option value="">None</option>
                    </select>
                    <label class="block text-xs text-gray-400 mb-1">Featured Artist 2</label>
                    <select id="release-feature-2" class="w-full bg-[#121212] border border-[#333] rounded p-2 text-white focus:border-white outline-none mb-2">
                        <option value="">None</option>
                    </select>
                    <label class="block text-xs text-gray-400 mb-1">Featured Artist 3</label>
                    <select id="release-feature-3" class="w-full bg-[#121212] border border-[#333] rounded p-2 text-white focus:border-white outline-none">
                        <option value="">None</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs text-gray-400 mb-1">Cover Art</label>
                    <input type="text" id="release-cover" placeholder="Image URL (optional)" class="w-full bg-[#121212] border border-[#333] rounded p-2 text-white focus:border-white outline-none mb-2">
                    <div class="text-center text-xs text-gray-500 mb-2">- OR Upload -</div>
                    <input type="file" id="release-cover-file" accept="image/*" class="w-full text-xs text-gray-400">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Vibe/Mood</label>
                    <select id="release-mood" class="w-full bg-[#121212] border border-[#333] rounded p-2 text-white focus:border-white outline-none">
                        <option value="All">General</option>
                        <option value="Energize">Energize</option>
                        <option value="Relax">Relax</option>
                        <option value="Commute">Commute</option>
                        <option value="Focus">Focus</option>
                        <option value="Workout">Workout</option>
                    </select>
                </div>
                <button onclick="confirmRelease()" class="w-full bg-white text-black font-bold py-2 rounded-full hover:bg-gray-200 mt-2">Release Now</button>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div id="about-modal" class="modal fixed inset-0 z-[80] bg-black/80 flex items-center justify-center p-4">
        <div class="modal-content bg-[#212121] w-full max-w-2xl rounded-xl shadow-2xl overflow-hidden border border-[#333]">
            <div class="p-4 border-b border-[#333] flex justify-between items-center">
                <h2 class="text-xl font-bold">About Artist</h2>
                <button onclick="closeModal('about-modal')" class="text-gray-400 hover:text-white"><span class="material-icons-round">close</span></button>
            </div>
            <div class="p-8" id="about-modal-content">
                <!-- Injected via JS -->
            </div>
        </div>
    </div>

    <script>
        // --- STATE & STORAGE ---
        let state = {
            artists: [],
            releases: [],
            library: [],
            simTime: Date.now(), // Simulation time decoupled from real time
            lastSaveTime: Date.now(),
            activeFilter: 'All'
        };

        let playerState = {
            isPlaying: false,
            currentReleaseId: null,
            currentTrackIndex: 0,
            audioUrl: null,
            release: null,
            track: null
        };

        const demoAudioBase64 = "data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV6enp6enp6enp6enp6enp6enp6enp6enp////84QAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAP/zgAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV6enp6enp6enp6enp6enp6enp6enp6enp////84QAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAP/zgAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAA";

        const audioElement = document.getElementById('audio-element');

        const generateId = () => Math.random().toString(36).substr(2, 9);
        
        const formatNumber = (num) => {
            if (!isFinite(num)) return "Max";
            if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return Math.floor(num).toString();
        };

        // --- HELPER: IMAGE UPLOAD ---
        const getImageUrl = async (fileInputId, urlInputId) => {
            const fileInput = document.getElementById(fileInputId);
            const urlInput = document.getElementById(urlInputId);

            if (fileInput.files && fileInput.files[0]) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result); 
                    reader.onerror = (e) => reject(e);
                    reader.readAsDataURL(fileInput.files[0]);
                });
            }
            return urlInput.value || ''; 
        }

        // --- INIT ---
        function init() {
            loadFromLocal();
            
            // Ensure simTime exists if loading old save
            if (!state.simTime) state.simTime = Date.now();

            if (state.artists.length <= 1) {
                seedArtists();
            }
            
            const now = Date.now();
            const elapsedSeconds = (now - state.lastSaveTime) / 1000;
            if (elapsedSeconds > 60) {
                simulateOffline(elapsedSeconds);
            }

            renderHome();
            updateSidebar();
            
            // Real-time loop progresses time slowly
            setInterval(() => {
                state.simTime += 2000; // Advance sim time by 2s every 2s
                simulateRealTime(2); // Simulate 2s of views
                saveToLocal();
                updateRealTimeUI(); 
                updatePlayerUIStats();
            }, 2000);

            audioElement.addEventListener('timeupdate', () => {
                const current = audioElement.currentTime;
                const duration = audioElement.duration || 0;
                document.getElementById('player-seek').value = (current / duration) * 100 || 0;
                document.getElementById('player-time-current').innerText = formatTime(current);
                document.getElementById('player-time-total').innerText = formatTime(duration);
            });
            audioElement.addEventListener('ended', playNext);
            
            document.getElementById('player-seek').addEventListener('input', (e) => {
                const percent = e.target.value;
                const duration = audioElement.duration;
                if(duration) audioElement.currentTime = (percent / 100) * duration;
            });
        }

        function seedArtists() {
            const yeatId = createArtistInternal("Yeat", "https://images.unsplash.com/photo-1621360841013-c768371e93cf?w=400&q=80", "Twizzy Rich.", 5000000, 2000000, "He/Him");
            createReleaseInternal(yeatId, "2 Alivë", "Album", "https://images.unsplash.com/photo-1614613535308-eb5fbd3d2c17?w=400", ["Monëy so big", "Poppin", "Outsidë", "Nvr again"], "Energize");

            const juiceId = createArtistInternal("Juice WRLD", "https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=400&q=80", "999 Forever.", 15000000, 8000000, "He/Him");
            createReleaseInternal(juiceId, "Goodbye & Good Riddance", "Album", "https://images.unsplash.com/photo-1619983081563-430f63602796?w=400", ["Lucid Dreams", "All Girls Are The Same", "Lean Wit Me", "Wasted"], "Relax");

            const nbaId = createArtistInternal("NBA Youngboy", "https://images.unsplash.com/photo-1598387993441-a364f854c3e1?w=400&q=80", "Top.", 8000000, 4000000, "He/Him");
            createReleaseInternal(nbaId, "Top", "Album", "https://images.unsplash.com/photo-1621112904891-2867e0ce5854?w=400", ["Right Foot Creep", "Kacey Talk", "My Window", "Drug Addiction"], "Commute");

            const drakeId = createArtistInternal("Drake", "https://images.unsplash.com/photo-1570295999919-56ceb5ecca61?w=400&q=80", "6 God.", 40000000, 15000000, "He/Him");
            createReleaseInternal(drakeId, "Scorpion", "Album", "https://images.unsplash.com/photo-1619983081593-e2ba5b543e60?w=400", ["God's Plan", "Nice For What", "In My Feelings", "Nonstop"], "Energize");

            const taylorId = createArtistInternal("Taylor Swift", "https://images.unsplash.com/photo-1542596594-649edbc13630?w=400&q=80", "The Music Industry.", 60000000, 25000000, "She/Her");
            createReleaseInternal(taylorId, "1989", "Album", "https://images.unsplash.com/photo-1493225255756-d9584f8606e9?w=400", ["Blank Space", "Style", "Shake It Off", "Bad Blood"], "Relax");
        }

        function createReleaseInternal(artistId, title, type, cover, trackNames, mood = "All") {
            const tracksData = trackNames.map((t, i) => ({
                title: t,
                weight: i === 0 ? 0.4 : 0.2,
                duration: "3:30",
                hasDemo: true,
                views: Math.floor((Math.random() * 500000 * (i === 0 ? 0.4 : 0.2)) + 5000) 
            }));

            const total = tracksData.reduce((acc, curr) => acc + curr.views, 0);

            const newRelease = {
                id: generateId(),
                artistId: artistId,
                featuredArtistIds: [],
                title: title,
                type: type,
                cover: cover,
                tracks: tracksData.length,
                tracksData: tracksData,
                releaseTimestamp: state.simTime - (Math.random() * 1000000000), 
                totalViews: total,
                popularityScore: Math.random() * 0.5 + 0.5,
                mood: mood,
                weeklyViews: Math.floor(Math.random() * 10000) // Initial chart seeding
            };
            
            // Update Artist Last Release
            const artist = state.artists.find(a => a.id === artistId);
            if(artist) artist.lastReleaseTime = newRelease.releaseTimestamp;

            state.releases.push(newRelease);
        }

        function formatTime(seconds) {
            if(isNaN(seconds)) return "0:00";
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }

        function handleSearch(query) {
            if (!query) {
                if (document.getElementById('main-content').dataset.view === 'search') {
                    renderHome();
                }
                return;
            }

            const lowerQ = query.toLowerCase();
            const main = document.getElementById('main-content');
            main.dataset.view = 'search';
            
            const artistResults = state.artists.filter(a => a.name.toLowerCase().includes(lowerQ));
            let songResults = [];
            state.releases.forEach(r => {
                r.tracksData.forEach((t, idx) => {
                    if (t.title.toLowerCase().includes(lowerQ)) {
                        const artist = state.artists.find(a => a.id === r.artistId);
                        songResults.push({
                            trackTitle: t.title,
                            artistName: artist.name,
                            release: r,
                            trackIndex: idx
                        });
                    }
                });
            });

            main.innerHTML = `
                <div class="space-y-8 pb-20 animate-fade-in">
                    <h1 class="text-2xl font-bold mb-4">Search Results for "${query}"</h1>
                    
                    ${artistResults.length > 0 ? `
                        <section>
                            <h2 class="text-xl font-bold mb-4 text-gray-300">Artists</h2>
                            <div class="artist-grid">
                                ${artistResults.map(artist => `
                                    <div onclick="renderArtist('${artist.id}')" class="group cursor-pointer p-4 rounded-md hover:bg-[#1f1f1f] transition">
                                        <img src="${artist.pfp}" class="w-full aspect-square object-cover rounded-full mb-4 shadow-lg">
                                        <h3 class="font-bold text-white truncate">${artist.name}</h3>
                                        <p class="text-sm text-yt-textSec">Artist</p>
                                    </div>
                                `).join('')}
                            </div>
                        </section>
                    ` : ''}

                    ${songResults.length > 0 ? `
                        <section>
                            <h2 class="text-xl font-bold mb-4 text-gray-300">Songs</h2>
                            <div class="flex flex-col">
                                ${songResults.map(item => `
                                    <div onclick="trackClicked('${item.release.id}', ${item.trackIndex})" class="flex items-center gap-4 p-3 rounded hover:bg-[#1f1f1f] group cursor-pointer transition">
                                        <img src="${item.release.cover}" class="w-12 h-12 rounded object-cover">
                                        <div class="flex-1 min-w-0">
                                            <div class="font-medium text-white truncate">${item.trackTitle}</div>
                                            <div class="text-sm text-gray-400">${item.artistName}</div>
                                        </div>
                                        <div class="text-sm text-gray-400 mr-4">Play</div>
                                    </div>
                                `).join('')}
                            </div>
                        </section>
                    ` : ''}

                    ${artistResults.length === 0 && songResults.length === 0 ? '<p class="text-gray-500">No results found.</p>' : ''}
                </div>
            `;
        }

        // --- PLAYER LOGIC ---

        function trackClicked(releaseId, trackIndex) {
            const release = state.releases.find(r => r.id === releaseId);
            const track = release.tracksData[trackIndex];

            if (track.hasDemo) {
                loadAndPlay(releaseId, trackIndex, demoAudioBase64);
                return;
            }

            document.getElementById('mp3-upload').onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    loadAndPlay(releaseId, trackIndex, url);
                }
            };
            document.getElementById('mp3-upload').click();
        }

        function loadAndPlay(releaseId, trackIndex, url) {
            const release = state.releases.find(r => r.id === releaseId);
            if (!release) return;

            playerState.currentReleaseId = releaseId;
            playerState.currentTrackIndex = trackIndex;
            playerState.release = release;
            playerState.track = release.tracksData[trackIndex];
            playerState.audioUrl = url;
            playerState.isPlaying = true;

            audioElement.src = url;
            audioElement.play().catch(e => console.log("Auto-play blocked", e));

            openPlayer();
            updatePlayerUI();
        }

        function updatePlayerUI() {
            const { release, track } = playerState;
            const artist = state.artists.find(a => a.id === release.artistId);
            
            let featNames = "";
            if(release.featuredArtistIds && release.featuredArtistIds.length > 0) {
                const feats = state.artists.filter(a => release.featuredArtistIds.includes(a.id));
                featNames = feats.length > 0 ? ` ft. ${feats.map(f => f.name).join(', ')}` : "";
            } else if (release.featuredArtistId) {
                const f = state.artists.find(a => a.id === release.featuredArtistId);
                if(f) featNames = ` ft. ${f.name}`;
            }

            document.getElementById('player-title').innerText = track.title;
            document.getElementById('player-artist').innerText = artist.name + featNames;
            document.getElementById('player-img').src = release.cover;
            
            updatePlayerUIStats();
            updatePlayButton();
        }

        function updatePlayerUIStats() {
            if(!playerState.release) return;
            const likeRatio = 0.02 + (playerState.release.id.charCodeAt(0) % 4) * 0.01; 
            const likes = Math.floor(playerState.release.totalViews * likeRatio);
            
            document.getElementById('player-views').innerText = formatNumber(playerState.release.totalViews);
            document.getElementById('player-likes').innerText = formatNumber(likes);
        }

        function togglePlay() {
            if (audioElement.paused) {
                audioElement.play();
                playerState.isPlaying = true;
            } else {
                audioElement.pause();
                playerState.isPlaying = false;
            }
            updatePlayButton();
        }

        function updatePlayButton() {
            const icon = document.getElementById('player-play-icon');
            icon.innerText = playerState.isPlaying ? 'pause' : 'play_arrow';
        }

        function openPlayer() {
            const p = document.getElementById('music-player');
            p.classList.remove('hidden');
            p.classList.add('animate-slide-up');
            p.classList.remove('animate-slide-down');
        }

        function closePlayer() {
            const p = document.getElementById('music-player');
            p.classList.add('animate-slide-down');
            p.classList.remove('animate-slide-up');
            setTimeout(() => {
                p.classList.add('hidden');
            }, 300);
        }

        function playNext() {
            if (playerState.currentTrackIndex < playerState.release.tracksData.length - 1) {
                const nextIdx = playerState.currentTrackIndex + 1;
                const nextTrack = playerState.release.tracksData[nextIdx];
                if(nextTrack.hasDemo) {
                    loadAndPlay(playerState.currentReleaseId, nextIdx, demoAudioBase64);
                } else {
                    playerState.isPlaying = false;
                    updatePlayButton();
                }
            }
        }

        // --- SIMULATION ENGINE ---

        // Function for manual time skipping (Days)
        function skipTime(days) {
            const secondsPerDay = 86400;
            // Iterate day by day to simulate natural decay over the week
            for(let i=0; i<days; i++) {
                simulateRealTime(secondsPerDay); // Simulate day using current time
                state.simTime += (secondsPerDay * 1000); // Advance time for next day calc
                
                // Weekly reset logic (basic approx)
                if (i % 7 === 0) {
                    state.releases.forEach(r => r.weeklyViews = 0);
                }
            }
            alert(`Skipped ${days} day(s). Stats updated.`);
            saveToLocal();
            const main = document.getElementById('main-content');
            if (main.dataset.view === 'home') renderHome();
            else if (main.dataset.view === 'artist') renderArtist(main.dataset.viewId);
            else if (main.dataset.view === 'charts') renderCharts();
        }

        function simulateRealTime(seconds) {
            state.releases.forEach(release => {
                const ageHours = (state.simTime - release.releaseTimestamp) / (1000 * 60 * 60);
                const ageDays = ageHours / 24;
                
                let decayFactor = 1;
                // Peak hype first 2 days
                if (ageDays < 2) {
                    decayFactor = 1.0; 
                } else if (ageDays < 7) {
                    // First week drop off
                    decayFactor = 0.8 - ((ageDays - 2) * 0.1); 
                } else {
                    // Long tail decay: aggressive fall off
                    // Older songs barely get views unless viral
                    decayFactor = 1.5 / Math.pow(ageDays, 2); 
                }
                
                // Ensure a "Long Tail" floor for bigger artists so views don't hit 0
                const artist = state.artists.find(a => a.id === release.artistId);
                const minDaily = Math.max(10, artist.subscribers * 0.001); // e.g. 10M subs = 10k daily min
                const minFactor = (minDaily / (artist.subscribers * 0.01)) || 0.001; 
                
                if (decayFactor < minFactor) decayFactor = minFactor + (Math.random() * 0.005); // Add jitter

                // Saturation Cap
                const potentialAudience = artist.subscribers * 50; 
                if (release.totalViews > potentialAudience) {
                    decayFactor *= 0.05; 
                } else if (release.totalViews > artist.subscribers * 10) {
                    decayFactor *= 0.2; 
                }

                // NERFED BASE RATE (10x reduction)
                const baseRate = Math.max(0.01, artist.subscribers * 0.00001); 
                
                let featureMult = 1;
                if(release.featuredArtistIds && release.featuredArtistIds.length > 0) {
                    // BOOSTED FEATURE LOGIC: Features now give significant multiplier (3x for 3 artists)
                    featureMult = 1 + (release.featuredArtistIds.length * 0.7); 
                } else if(release.featuredArtistId) {
                    featureMult = 1.8;
                }

                const viewsPerSecond = baseRate * release.popularityScore * decayFactor * featureMult;
                // Smoother randomness
                const actualViews = viewsPerSecond * seconds * (0.9 + Math.random() * 0.2);
                
                if (actualViews > 0) {
                    release.totalViews += actualViews;
                    if(!release.weeklyViews) release.weeklyViews = 0;
                    release.weeklyViews += actualViews;
                    
                    // Distribute views to tracks
                    release.tracksData.forEach(t => {
                        if(!t.views) t.views = 0;
                        t.views += actualViews * (t.weight || (1/release.tracks));
                    });
                }
            });

            updateArtistStats();
        }

        function simulateOffline(seconds) {
            simulateRealTime(seconds); 
            const toast = document.getElementById('offline-toast');
            const text = document.getElementById('offline-report-text');
            text.innerText = `Simulated ${Math.floor(seconds / 60)} minutes of activity while you were away.`;
            toast.classList.remove('toast-hidden');
        }

        function updateArtistStats() {
            state.artists.forEach(artist => {
                const relevantReleases = state.releases.filter(r => {
                    const isMain = r.artistId === artist.id;
                    const isFeatSingle = r.featuredArtistId === artist.id;
                    const isFeatMulti = r.featuredArtistIds && r.featuredArtistIds.includes(artist.id);
                    return isMain || isFeatSingle || isFeatMulti;
                });

                const totalViews = relevantReleases.reduce((sum, r) => sum + r.totalViews, 0);
                
                const prevViews = artist.totalViews;
                artist.growthRate = totalViews - prevViews; 
                artist.totalViews = totalViews;

                // Monthly Listeners Logic
                // Check last release date
                const weeksSinceRelease = (state.simTime - (artist.lastReleaseTime || 0)) / (1000 * 60 * 60 * 24 * 7);
                
                let listenerDecay = 0.999; // Standard slow decay
                if (weeksSinceRelease > 8) {
                    listenerDecay = 0.98; // Accelerated decay after 8 weeks
                }

                if (artist.growthRate > 0) {
                   artist.monthlyListeners += (artist.growthRate * 0.5); 
                } 
                
                // Always decay listeners slightly to require new releases to maintain
                artist.monthlyListeners *= listenerDecay;
                
                if (artist.growthRate > 0) {
                    let subFactor = 0.005;
                    if(artist.subscribers > 1000000) subFactor = 0.001;
                    if(artist.subscribers > 10000000) subFactor = 0.0001;
                    artist.subscribers += (artist.growthRate * subFactor);
                }
            });
        }

        function updateRealTimeUI() {
             // Keep UI light
        }

        // --- DATA PERSISTENCE ---

        function saveToLocal() {
            try {
                localStorage.setItem('yt_sim_save', JSON.stringify(state));
            } catch (e) {
                console.warn("Save failed");
            }
        }

        function loadFromLocal() {
            const data = localStorage.getItem('yt_sim_save');
            if (data) {
                const parsed = JSON.parse(data);
                state = { ...state, ...parsed };
            }
        }

        function downloadSave() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "peyza_music_save_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode); 
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function uploadSave(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedState = JSON.parse(e.target.result);
                    state = loadedState;
                    saveToLocal();
                    location.reload(); 
                } catch (err) {
                    alert("Invalid Save File");
                }
            };
            reader.readAsText(file);
        }

        function resetData() {
            if(confirm("Are you sure? This deletes all artists.")) {
                localStorage.removeItem('yt_sim_save');
                location.reload();
            }
        }

        // --- UI ACTIONS ---

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        function animateNav(id, callback) {
            const btn = document.getElementById(id);
            if (btn) {
                btn.classList.remove('animating');
                void btn.offsetWidth; 
                btn.classList.add('animating');
            }
            callback();
        }

        function closeOfflineToast() {
            document.getElementById('offline-toast').classList.add('toast-hidden');
        }
        
        function updateNavState(view) {
            ['nav-home', 'nav-explore', 'nav-charts', 'nav-library'].forEach(id => {
                const btn = document.getElementById(id);
                if (id === 'nav-'+view) {
                    btn.classList.add('bg-[#1f1f1f]', 'text-white');
                    btn.classList.remove('text-yt-textSec');
                } else {
                    btn.classList.remove('bg-[#1f1f1f]', 'text-white');
                    btn.classList.add('text-yt-textSec');
                }
            });
             ['mob-nav-home', 'mob-nav-explore', 'mob-nav-charts', 'mob-nav-library', 'mob-nav-create'].forEach(id => {
                const btn = document.getElementById(id);
                if (id === 'mob-nav-'+view) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function filterHome(mood) {
            state.activeFilter = mood;
            renderHome();
        }

        // --- ARTIST & RELEASES LOGIC ---

        function createArtistInternal(name, pfp, bio, monthly, subs, pronouns) {
            const newArtist = {
                id: generateId(),
                name: name,
                pfp: pfp,
                banner: "https://images.unsplash.com/photo-1516280440614-6697288d5d38?q=80&w=1200&auto=format&fit=crop",
                bio: bio || "New artist on the scene.",
                subscribers: subs,
                monthlyListeners: monthly,
                totalViews: 0,
                growthRate: 0,
                pronouns: pronouns || "They/Them",
                lastReleaseTime: Date.now() - (1000 * 60 * 60 * 24 * 7 * 4) // Default 4 weeks ago
            };
            state.artists.push(newArtist);
            updateSidebar();
            saveToLocal();
            return newArtist.id;
        }

        async function createArtist() {
            const name = document.getElementById('new-artist-name').value;
            const bio = document.getElementById('new-artist-bio').value;
            const pronouns = document.getElementById('new-artist-pronouns').value;
            let pfp = await getImageUrl('new-artist-pfp-file', 'new-artist-pfp');
            if(!pfp) pfp = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random`;

            if (!name) return alert("Name is required");
            
            const id = createArtistInternal(name, pfp, bio, 0, 0, pronouns);
            
            document.getElementById('new-artist-name').value = '';
            document.getElementById('new-artist-pfp').value = '';
            document.getElementById('new-artist-pfp-file').value = '';
            document.getElementById('new-artist-bio').value = '';
            document.getElementById('new-artist-pronouns').value = '';

            closeModal('create-artist-modal');
            renderArtist(id);
        }

        async function confirmRelease() {
            const artistId = document.getElementById('release-artist-id').value;
            const title = document.getElementById('release-title').value;
            const type = document.getElementById('release-type').value;
            const trackCount = parseInt(document.getElementById('release-tracks').value);
            const mood = document.getElementById('release-mood').value;
            
            const feat1 = document.getElementById('release-feature-1').value;
            const feat2 = document.getElementById('release-feature-2').value;
            const feat3 = document.getElementById('release-feature-3').value;
            const featuredArtistIds = [feat1, feat2, feat3].filter(id => id && id !== "");

            let cover = await getImageUrl('release-cover-file', 'release-cover');
            if(!cover) cover = `https://ui-avatars.com/api/?name=${encodeURIComponent(title)}&size=300&background=222&color=fff`;

            if (!title) return alert("Title required");

            const tracksData = [];
            for (let i = 0; i < trackCount; i++) {
                let trackTitle = type === 'Single' ? title : (i === 0 ? title : `${title} - Part ${i+1}`);
                let weight = 0;
                if (i === 0) weight = 0.4;
                else if (i === 1) weight = 0.2;
                else weight = 0.4 / (trackCount - 2 || 1); 

                tracksData.push({
                    title: trackTitle,
                    weight: weight,
                    duration: `${Math.floor(Math.random()*3)+2}:${Math.floor(Math.random()*50)+10}`,
                    views: 0
                });
            }

            const newRelease = {
                id: generateId(),
                artistId: artistId,
                featuredArtistIds: featuredArtistIds, 
                title: title,
                type: type,
                cover: cover,
                tracks: trackCount,
                tracksData: tracksData,
                releaseTimestamp: state.simTime, 
                totalViews: 0,
                weeklyViews: 0,
                popularityScore: Math.random() * 0.5 + 0.5,
                mood: mood
            };
            
            // Update last release for main artist
            const artist = state.artists.find(a => a.id === artistId);
            if(artist) artist.lastReleaseTime = state.simTime;

            state.releases.unshift(newRelease);
            
            // Clear inputs
            document.getElementById('release-title').value = '';
            document.getElementById('release-cover').value = '';
            document.getElementById('release-cover-file').value = '';
            document.getElementById('release-tracks').value = 1;
            document.getElementById('release-feature-1').value = "";
            document.getElementById('release-feature-2').value = "";
            document.getElementById('release-feature-3').value = "";

            closeModal('release-music-modal');
            saveToLocal();
            renderArtist(artistId);
        }

         function toggleSubscribe(artistId) {
            const index = state.library.indexOf(artistId);
            const artist = state.artists.find(a => a.id === artistId);
            
            // Add animation class to icon
            const btnIcon = document.getElementById(`sub-icon-${artistId}`);
            if(btnIcon) {
                btnIcon.classList.remove('animate-thumb');
                void btnIcon.offsetWidth; // trigger reflow
                btnIcon.classList.add('animate-thumb');
            }

            if (index === -1) {
                state.library.push(artistId);
                if(artist) artist.subscribers++;
            } else {
                state.library.splice(index, 1);
                if(artist && artist.subscribers > 0) artist.subscribers--;
            }
            saveToLocal();
            
            const content = document.getElementById('main-content');
            if (content.dataset.view === 'artist' && content.dataset.viewId === artistId) {
                renderArtist(artistId);
            } else if (content.dataset.view === 'library') {
                renderLibrary();
            }
        }

        // --- RENDERERS ---

        function renderHome() {
            const main = document.getElementById('main-content');
            main.dataset.view = 'home';
            main.dataset.viewId = '';
            updateNavState('home');

            let sortedReleases = [...state.releases].sort((a, b) => b.totalViews - a.totalViews);
            
            // Apply Filter
            if (state.activeFilter !== 'All') {
                sortedReleases = sortedReleases.filter(r => r.mood === state.activeFilter);
            }

            const filterBtnClass = (mood) => `px-3 py-1 rounded-lg text-sm font-medium transition whitespace-nowrap ${state.activeFilter === mood ? 'bg-white text-black' : 'bg-[#212121] border border-[#333] hover:bg-[#333]'}`;

            main.innerHTML = `
                <div class="space-y-8 pb-20 animate-fade-in">
                    <!-- Filters -->
                    <div class="flex gap-2 sticky top-0 bg-[#030303] z-10 py-2 overflow-x-auto no-scrollbar">
                        <button onclick="filterHome('All')" class="${filterBtnClass('All')}">All</button>
                        <button onclick="filterHome('Energize')" class="${filterBtnClass('Energize')}">Energize</button>
                        <button onclick="filterHome('Relax')" class="${filterBtnClass('Relax')}">Relax</button>
                        <button onclick="filterHome('Commute')" class="${filterBtnClass('Commute')}">Commute</button>
                        <button onclick="filterHome('Focus')" class="${filterBtnClass('Focus')}">Focus</button>
                        <button onclick="filterHome('Workout')" class="${filterBtnClass('Workout')}">Workout</button>
                    </div>

                    <section>
                        <div class="flex items-end justify-between mb-4">
                            <h2 class="text-2xl font-bold">Recommended for You</h2>
                        </div>
                        ${sortedReleases.length === 0 ? '<div class="text-gray-500 italic">No releases match this filter.</div>' : ''}
                        <div class="discography-grid">
                            ${sortedReleases.slice(0, 12).map(r => getReleaseCard(r)).join('')}
                        </div>
                    </section>
                    
                    <section>
                        <div class="flex items-end justify-between mb-4">
                            <h2 class="text-2xl font-bold">Your Favorites</h2>
                        </div>
                        <div class="artist-grid">
                            ${state.artists.map(artist => `
                                <div onclick="renderArtist('${artist.id}')" class="group cursor-pointer p-4 rounded-md hover:bg-[#1f1f1f] transition">
                                    <div class="relative mb-4">
                                        <img src="${artist.pfp}" class="w-full aspect-square object-cover rounded-full shadow-lg group-hover:scale-105 transition duration-300">
                                        <div class="absolute bottom-2 right-2 w-10 h-10 bg-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition shadow-xl">
                                            <span class="material-icons-round text-black">play_arrow</span>
                                        </div>
                                    </div>
                                    <h3 class="font-bold text-white truncate">${artist.name}</h3>
                                    <p class="text-sm text-yt-textSec">Artist • ${formatNumber(artist.subscribers)} subs</p>
                                </div>
                            `).join('')}
                        </div>
                    </section>
                </div>
            `;
        }

        // New Chart Page
        function renderCharts() {
            const main = document.getElementById('main-content');
            main.dataset.view = 'charts';
            updateNavState('charts');

            // Flatten tracks to find top songs by WEEKLY views
            let allTracks = [];
            state.releases.forEach(r => {
                const artist = state.artists.find(a => a.id === r.artistId);
                r.tracksData.forEach((t, idx) => {
                    // Estimate weekly views per track based on weight
                    const weeklyTrackViews = Math.floor((r.weeklyViews || 0) * (t.weight || (1/r.tracks)));
                    allTracks.push({
                        title: t.title,
                        artist: artist.name,
                        cover: r.cover,
                        releaseId: r.id,
                        trackIndex: idx,
                        weekly: weeklyTrackViews
                    });
                });
            });

            // Fake randomization for regional charts since we don't simulate regions
            // We just shuffle slightly based on the region string length to make it deterministic but different
            const region = main.dataset.region || 'Global';
            
            // Sort by weekly views
            allTracks.sort((a, b) => b.weekly - a.weekly);
            
            // Simple shuffle for "Regions" to fake diversity
            if (region !== 'Global') {
                allTracks.sort((a,b) => (b.weekly * ((a.title.length % 3) * 0.1)) - (a.weekly * ((b.title.length % 3) * 0.1)));
            }

            const top100 = allTracks.slice(0, 100);

            const filterClass = (r) => `px-4 py-2 rounded-full text-sm font-bold border transition whitespace-nowrap ${region === r ? 'bg-white text-black border-white' : 'bg-transparent text-gray-400 border-gray-600 hover:border-white hover:text-white'}`;

            main.innerHTML = `
                <div class="space-y-6 pb-20 animate-fade-in">
                    <div class="flex flex-col gap-2">
                        <h1 class="text-4xl font-black">Charts</h1>
                        <p class="text-gray-400">The most played songs on PeytoToria this week.</p>
                    </div>

                    <!-- Region Filters -->
                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                        <button onclick="switchChartRegion('Global')" class="${filterClass('Global')}">Global</button>
                        <button onclick="switchChartRegion('USA')" class="${filterClass('USA')}">USA</button>
                        <button onclick="switchChartRegion('Europe')" class="${filterClass('Europe')}">Europe</button>
                        <button onclick="switchChartRegion('Russia')" class="${filterClass('Russia')}">Russia</button>
                        <button onclick="switchChartRegion('China')" class="${filterClass('China')}">China</button>
                        <button onclick="switchChartRegion('Asia')" class="${filterClass('Asia')}">Asia</button>
                        <button onclick="switchChartRegion('Pacific')" class="${filterClass('Pacific')}">Pacific</button>
                    </div>

                    <div class="flex flex-col gap-1">
                        <div class="text-xs font-bold text-gray-500 uppercase tracking-widest px-4 mb-2">Top 100 • ${region}</div>
                        ${top100.map((track, i) => `
                            <div onclick="trackClicked('${track.releaseId}', ${track.trackIndex})" class="flex items-center gap-4 p-3 rounded hover:bg-[#1f1f1f] group cursor-pointer transition">
                                <div class="w-8 text-center font-bold text-lg ${i < 3 ? 'text-white' : 'text-gray-500'}">${i + 1}</div>
                                <img src="${track.cover}" class="w-12 h-12 rounded object-cover shadow-sm">
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-white truncate">${track.title}</div>
                                    <div class="text-sm text-gray-400 truncate">${track.artist}</div>
                                </div>
                                <div class="text-sm text-gray-500 font-medium">${formatNumber(track.weekly)} plays</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function switchChartRegion(region) {
            const main = document.getElementById('main-content');
            main.dataset.region = region;
            renderCharts();
        }

        function renderExplore() {
            const main = document.getElementById('main-content');
            main.dataset.view = 'explore';
            updateNavState('explore');

            const newReleases = [...state.releases].sort((a, b) => b.releaseTimestamp - a.releaseTimestamp).slice(0, 8);
            const trendingArtists = [...state.artists].sort((a, b) => b.growthRate - a.growthRate).slice(0, 8);

            main.innerHTML = `
                <div class="space-y-8 pb-20 animate-fade-in">
                    <h1 class="text-4xl font-bold mb-6">Explore</h1>

                    <section>
                        <h2 class="text-2xl font-bold mb-4">New Releases</h2>
                        <div class="discography-grid">
                            ${newReleases.map(r => getReleaseCard(r)).join('')}
                        </div>
                    </section>

                    <section>
                        <h2 class="text-2xl font-bold mb-4">Trending Artists <span class="text-sm font-normal text-gray-500 ml-2">(High Velocity)</span></h2>
                        <div class="artist-grid">
                            ${trendingArtists.map(artist => `
                                <div onclick="renderArtist('${artist.id}')" class="group cursor-pointer p-4 rounded-md hover:bg-[#1f1f1f] transition">
                                    <img src="${artist.pfp}" class="w-full aspect-square object-cover rounded-full mb-4 shadow-lg">
                                    <h3 class="font-bold text-white truncate">${artist.name}</h3>
                                    <p class="text-sm text-green-400">Trending Now</p>
                                </div>
                            `).join('')}
                        </div>
                    </section>
                </div>
            `;
        }

        function renderRelease(releaseId) {
            const release = state.releases.find(r => r.id === releaseId);
            if (!release) return;

            const main = document.getElementById('main-content');
            main.dataset.view = 'release';
            main.dataset.viewId = releaseId;
            updateNavState('');

            const artist = state.artists.find(a => a.id === release.artistId);
            
            // Handle Feature display on page
            let featNames = "";
            if(release.featuredArtistIds && release.featuredArtistIds.length > 0) {
                const feats = state.artists.filter(a => release.featuredArtistIds.includes(a.id));
                featNames = feats.length > 0 ? ` & ${feats.map(f => f.name).join(', ')}` : "";
            } else if (release.featuredArtistId) {
                 const f = state.artists.find(a => a.id === release.featuredArtistId);
                 if(f) featNames = ` & ${f.name}`;
            }

            const likeRatio = 0.02 + (release.id.charCodeAt(0) % 4) * 0.01; 
            const likes = Math.floor(release.totalViews * likeRatio);

            // Calculate Ranking if trending
            // Flatten all tracks, sort by views, find index
            let allTracks = [];
            state.releases.forEach(r => {
                r.tracksData.forEach((t, idx) => {
                    let v = t.views || Math.floor(r.totalViews * (t.weight || 0));
                    allTracks.push({ ...t, views: v });
                });
            });
            allTracks.sort((a,b) => b.views - a.views);
            
            // Check top song of this release
            const bestTrackView = Math.floor(release.totalViews * (release.tracksData[0].weight || 0));
            const rank = allTracks.findIndex(t => t.views <= bestTrackView) + 1;
            
            let badge = "";
            if (rank <= 50) {
                badge = `<div class="inline-block bg-white text-black px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mb-2">#${rank} on Trending</div>`;
            }

            main.innerHTML = `
                 <div class="pb-20 max-w-7xl mx-auto animate-fade-in">
                    <div class="flex flex-col md:flex-row gap-8 mb-8">
                        <div class="w-full md:w-72 flex-shrink-0">
                            <img src="${release.cover}" class="w-full aspect-square object-cover rounded shadow-2xl">
                        </div>
                        <div class="flex flex-col justify-end">
                            ${badge}
                            <h2 class="text-4xl md:text-5xl font-black mb-4">${release.title}</h2>
                            <div class="flex items-center gap-2 mb-4">
                                <img src="${artist.pfp}" class="w-6 h-6 rounded-full">
                                <span class="font-bold text-white hover:underline cursor-pointer" onclick="renderArtist('${artist.id}')">${artist.name}${featNames}</span>
                            </div>
                            <div class="text-gray-400 text-sm flex gap-4 items-center">
                                <span>${release.type}</span>
                                <span>•</span>
                                <span class="flex items-center gap-1"><span class="material-icons-round text-sm">visibility</span> ${formatNumber(release.totalViews)}</span>
                                <span>•</span>
                                <span class="flex items-center gap-1"><span class="material-icons-round text-sm">thumb_up</span> ${formatNumber(likes)}</span>
                            </div>
                            <div class="flex gap-4 mt-6">
                                <button class="w-12 h-12 bg-white rounded-full flex items-center justify-center hover:scale-105 transition">
                                    <span class="material-icons-round text-black text-2xl">play_arrow</span>
                                </button>
                                <button class="w-12 h-12 bg-[#212121] rounded-full flex items-center justify-center hover:bg-[#333] transition">
                                    <span class="material-icons-round text-white text-2xl">library_add</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-[#030303]">
                         <div class="border-b border-[#1f1f1f] text-gray-400 text-sm py-2 px-4 grid grid-cols-[auto_1fr_auto] gap-4 mb-2">
                            <span>#</span>
                            <span>Title</span>
                            <span class="flex items-center gap-2"><span class="material-icons-round text-sm">visibility</span> Views</span>
                        </div>
                        <div class="flex flex-col">
                            ${release.tracksData.map((track, i) => {
                                const trackViews = track.views || Math.floor(release.totalViews * (track.weight || 0));
                                return `
                                <div onclick="trackClicked('${release.id}', ${i})" class="grid grid-cols-[auto_1fr_auto] gap-4 py-3 px-4 hover:bg-[#1f1f1f] rounded group items-center cursor-pointer transition">
                                    <div class="w-6 text-center text-gray-400 group-hover:hidden">${i + 1}</div>
                                    <div class="w-6 text-center hidden group-hover:block"><span class="material-icons-round text-white text-sm">play_arrow</span></div>
                                    <div class="flex flex-col">
                                        <span class="text-white font-medium">${track.title}</span>
                                        <span class="text-gray-500 text-xs">${artist.name}${featNames}</span>
                                    </div>
                                    <div class="text-gray-400 text-sm flex items-center gap-8">
                                        <span>${formatNumber(trackViews)}</span>
                                        <span>${track.duration}</span>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderArtist(id) {
            const artist = state.artists.find(a => a.id === id);
            if (!artist) return;

            const main = document.getElementById('main-content');
            main.dataset.view = 'artist';
            main.dataset.viewId = id;
            updateNavState('');
            
            const isSubscribed = state.library.includes(id);
            const artistReleases = state.releases.filter(r => r.artistId === id || (r.featuredArtistIds && r.featuredArtistIds.includes(id)) || r.featuredArtistId === id).sort((a,b) => b.releaseTimestamp - a.releaseTimestamp);
            
            let latestReleaseBanner = "";
            if (artistReleases.length > 0) {
                const latest = artistReleases[0];
                const ageHours = (state.simTime - latest.releaseTimestamp) / (1000 * 60 * 60);
                if (ageHours < 72) { 
                    latestReleaseBanner = `
                        <div onclick="renderRelease('${latest.id}')" class="bg-[#212121] border border-[#333] p-4 rounded-lg flex items-center gap-4 mb-6 cursor-pointer hover:bg-[#333] transition">
                            <img src="${latest.cover}" class="w-16 h-16 rounded object-cover">
                            <div class="flex-1">
                                <p class="text-xs text-yt-textSec uppercase font-bold tracking-wider mb-1">New Release</p>
                                <h3 class="font-bold text-white text-lg">Listen to the new ${latest.type.toLowerCase()} "${latest.title}"</h3>
                            </div>
                            <span class="material-icons-round text-3xl text-white">play_circle_filled</span>
                        </div>
                    `;
                }
            }

            let allTracks = [];
            artistReleases.forEach(r => {
                r.tracksData.forEach((t, idx) => {
                    let viewCount = t.views || Math.floor(r.totalViews * (t.weight || 0));
                    allTracks.push({
                        ...t,
                        release: r,
                        index: idx,
                        viewCount: viewCount
                    });
                });
            });
            const topSongs = allTracks.sort((a,b) => b.viewCount - a.viewCount).slice(0, 5);

            main.innerHTML = `
                <div class="pb-20 animate-fade-in">
                    <div class="relative w-full h-64 md:h-80 rounded-t-xl overflow-hidden mb-6 group">
                        <img src="${artist.banner}" class="w-full h-full object-cover brightness-75">
                        <div class="absolute inset-0 bg-gradient-to-t from-[#030303] via-transparent to-transparent"></div>
                        
                        <div class="absolute bottom-8 left-8">
                            <h1 class="text-4xl md:text-7xl font-black tracking-tighter mb-4 shadow-xl">${artist.name}</h1>
                            
                            <div class="flex items-center gap-2 text-sm font-medium text-gray-200 mb-4">
                                <span>${formatNumber(artist.monthlyListeners)} monthly audience</span>
                                <span class="w-1 h-1 bg-gray-400 rounded-full mx-1"></span>
                                <span>${artist.pronouns || 'They/Them'}</span>
                            </div>

                            <div class="flex items-center gap-4 mt-6">
                                <button onclick="toggleSubscribe('${artist.id}')" class="${isSubscribed ? 'bg-[#212121] text-white border border-[#333]' : 'bg-white text-black'} px-6 md:px-8 py-2 md:py-3 rounded-full font-bold uppercase tracking-wide hover:bg-gray-200 hover:text-black transition text-sm flex items-center gap-2">
                                    <span id="sub-icon-${artist.id}" class="material-icons-round text-lg">${isSubscribed ? 'thumb_up' : 'thumb_up_off_alt'}</span>
                                    <span>${isSubscribed ? 'Subscribed' : 'Subscribe'}</span>
                                    <span class="opacity-70 text-xs">• ${formatNumber(artist.subscribers)}</span>
                                </button>
                                <button class="bg-[#212121]/80 backdrop-blur-md border border-white/20 text-white px-4 py-2 md:py-3 rounded-full font-bold hover:bg-[#333] transition flex items-center gap-2 text-sm">
                                    <span class="material-icons-round">radio</span> Radio
                                </button>
                            </div>
                        </div>

                        <div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                             <button onclick="openReleaseModal('${artist.id}')" class="bg-blue-600 text-white px-4 py-2 rounded-full font-bold text-sm shadow-lg hover:bg-blue-700">Release Music</button>
                             <button onclick="openEditModal('${artist.id}')" class="bg-white text-black px-4 py-2 rounded-full font-bold text-sm shadow-lg hover:bg-gray-200">Edit Profile</button>
                        </div>
                    </div>

                    ${latestReleaseBanner}

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 space-y-8">
                            <section>
                                <h2 class="text-2xl font-bold mb-4">Top Songs</h2>
                                <div class="flex flex-col">
                                    ${topSongs.length > 0 ? topSongs.map((song, i) => `
                                        <div onclick="trackClicked('${song.release.id}', ${song.index})" class="flex items-center gap-4 p-3 rounded hover:bg-[#1f1f1f] group cursor-pointer transition">
                                            <span class="text-gray-400 w-4 text-center font-medium">${i + 1}</span>
                                            <img src="${song.release.cover}" class="w-12 h-12 rounded object-cover">
                                            <div class="flex-1 min-w-0">
                                                <div class="font-medium text-white truncate">${song.title}</div>
                                                <div class="text-sm text-gray-400">${formatNumber(song.viewCount)} views • ${song.release.title}</div>
                                            </div>
                                            <div class="text-sm text-gray-400 mr-4">Play</div>
                                        </div>
                                    `).join('') : '<div class="text-gray-500 italic">No releases yet.</div>'}
                                </div>
                            </section>

                            <section>
                                <h2 class="text-2xl font-bold mb-4">Discography</h2>
                                <div class="discography-grid">
                                    ${artistReleases.map(r => getReleaseCard(r)).join('')}
                                </div>
                            </section>
                        </div>

                        <div class="lg:col-span-1 space-y-8">
                            <section>
                                <h2 class="text-2xl font-bold mb-4">About</h2>
                                <div onclick="openAboutModal('${artist.id}')" class="relative rounded-lg overflow-hidden group cursor-pointer hover:ring-2 ring-white/20 transition">
                                    <div class="bg-[#1f1f1f] p-6 min-h-[200px] flex flex-col justify-end">
                                        <p class="text-white line-clamp-3 mb-4 font-serif italic">"${artist.bio}"</p>
                                        <div class="text-sm text-gray-400 flex justify-between items-end">
                                             <div>
                                                <div class="text-white font-bold text-lg">${formatNumber(artist.totalViews)}</div>
                                                <div>Total Career Views</div>
                                             </div>
                                             <div class="bg-gray-800 p-2 rounded-full hover:bg-gray-700 transition">
                                                <span class="material-icons-round text-white">arrow_forward</span>
                                             </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- HELPER COMPONENTS ---

        function getReleaseCard(release) {
             const artist = state.artists.find(a => a.id === release.artistId);
             
             let featureLabel = "";
             if (release.featuredArtistIds && release.featuredArtistIds.length > 0) {
                 featureLabel = `<span class="text-xs text-blue-400 block mt-1">+${release.featuredArtistIds.length} Features</span>`;
             } else if (release.featuredArtistId) {
                 const f = state.artists.find(a => a.id === release.featuredArtistId);
                 if(f) featureLabel = `<span class="text-xs text-blue-400 block mt-1">Feat. ${f.name}</span>`;
             }
             
             // Dynamic Rank Check for Card
             let badge = "";
             if (release.totalViews > 5000000) { // arbitrary threshold for UI demo
                 badge = `<div class="absolute top-2 left-2 bg-white text-black text-[10px] font-bold px-2 py-1 rounded uppercase shadow-lg">Trending</div>`;
             }

             return `
                <div onclick="renderRelease('${release.id}')" class="cursor-pointer group">
                    <div class="relative mb-3 overflow-hidden rounded-md">
                        <img src="${release.cover}" class="w-full aspect-square object-cover group-hover:opacity-80 transition">
                        ${badge}
                    </div>
                    <h3 class="font-medium text-white truncate">${release.title}</h3>
                    <p class="text-sm text-yt-textSec truncate">${artist.name} • ${release.type}</p>
                    <p class="text-xs text-gray-500 mt-1">${formatNumber(release.totalViews)} views</p>
                    ${featureLabel}
                </div>
            `;
        }

        function openAboutModal(id) {
            const artist = state.artists.find(a => a.id === id);
            const content = document.getElementById('about-modal-content');
            content.innerHTML = `
                <div class="flex gap-4 mb-6">
                    <img src="${artist.pfp}" class="w-24 h-24 rounded-full object-cover">
                    <div>
                        <h3 class="text-2xl font-bold">${artist.name}</h3>
                        <div class="text-gray-400">${formatNumber(artist.subscribers)} Subscribers</div>
                    </div>
                </div>
                <div class="bg-[#121212] p-4 rounded mb-4 text-sm leading-relaxed text-gray-300">${artist.bio}</div>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="bg-[#121212] p-4 rounded">
                        <div class="text-2xl font-bold text-white">${formatNumber(artist.totalViews)}</div>
                        <div class="text-xs text-gray-500 uppercase tracking-widest">Total Views</div>
                    </div>
                    <div class="bg-[#121212] p-4 rounded">
                        <div class="text-2xl font-bold text-white">${formatNumber(artist.monthlyListeners)}</div>
                        <div class="text-xs text-gray-500 uppercase tracking-widest">Monthly Listeners</div>
                    </div>
                </div>
            `;
            openModal('about-modal');
        }

        function updateSidebar() {
            const list = document.getElementById('sidebar-artist-list');
            list.innerHTML = state.artists.map(a => `
                <div onclick="renderArtist('${a.id}')" class="flex items-center gap-3 p-2 rounded-md hover:bg-[#1f1f1f] cursor-pointer transition">
                    <img src="${a.pfp}" class="w-8 h-8 rounded-full object-cover">
                    <div class="flex-1 min-w-0 nav-text">
                        <div class="text-sm font-medium text-white truncate">${a.name}</div>
                        <div class="text-xs text-yt-textSec">Artist</div>
                    </div>
                </div>
            `).join('');
        }

        function openModal(id) {
            const modal = document.getElementById(id);
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            modal.classList.remove('active');
            setTimeout(() => modal.classList.add('hidden'), 250);
        }

        function openEditModal(artistId) {
            const artist = state.artists.find(a => a.id === artistId);
            if (!artist) return;
            document.getElementById('edit-artist-id').value = artistId;
            document.getElementById('edit-artist-name').value = artist.name;
            document.getElementById('edit-artist-subs').value = artist.subscribers;
            document.getElementById('edit-artist-monthly').value = artist.monthlyListeners;
            document.getElementById('edit-artist-pfp').value = artist.pfp.startsWith('data:') ? '' : artist.pfp;
            document.getElementById('edit-artist-banner').value = artist.banner.startsWith('data:') ? '' : artist.banner;
            document.getElementById('edit-artist-bio').value = artist.bio;
            document.getElementById('edit-artist-pronouns').value = artist.pronouns || "They/Them";
            openModal('edit-profile-modal');
        }

        function openReleaseModal(artistId) {
            document.getElementById('release-artist-id').value = artistId;
            document.getElementById('release-title').value = '';
            document.getElementById('release-tracks').value = 1;
            document.getElementById('release-cover').value = '';
            document.getElementById('release-cover-file').value = '';
            
            // Populate multiple features
            ['release-feature-1', 'release-feature-2', 'release-feature-3'].forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="">None</option>';
                state.artists.forEach(a => {
                    if (a.id !== artistId) {
                        const option = document.createElement('option');
                        option.value = a.id;
                        option.text = a.name + ` (${formatNumber(a.subscribers)} subs)`;
                        select.appendChild(option);
                    }
                });
            });

            openModal('release-music-modal');
        }
        
        async function saveArtistProfile() {
            const id = document.getElementById('edit-artist-id').value;
            const artist = state.artists.find(a => a.id === id);
            
            if (artist) {
                artist.name = document.getElementById('edit-artist-name').value;
                artist.subscribers = parseInt(document.getElementById('edit-artist-subs').value);
                artist.monthlyListeners = parseInt(document.getElementById('edit-artist-monthly').value);
                
                // PFP
                const newPfp = await getImageUrl('edit-artist-pfp-file', 'edit-artist-pfp');
                if (newPfp) artist.pfp = newPfp;

                // Banner
                const newBanner = await getImageUrl('edit-artist-banner-file', 'edit-artist-banner');
                if (newBanner) artist.banner = newBanner;

                artist.bio = document.getElementById('edit-artist-bio').value;
                artist.pronouns = document.getElementById('edit-artist-pronouns').value;
                
                closeModal('edit-profile-modal');
                saveToLocal();
                renderArtist(id);
                updateSidebar();
            }
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target.id);
            }
        }

        init();
    </script>
</body>
</html>
