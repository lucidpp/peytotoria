<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PeytoToria</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts & Material Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        yt: {
                            base: '#030303',
                            sidebar: '#030303',
                            hover: '#1f1f1f',
                            text: '#ffffff',
                            textSec: '#aaaaaa',
                            red: '#ff0000',
                            accent: '#ffffff',
                            player: '#212121' 
                        }
                    },
                    fontFamily: {
                        sans: ['Roboto', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'explode': 'explode 0.6s ease-out forwards',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.2, 0.0, 0, 1.0) forwards',
                        'slide-down': 'slideDown 0.3s cubic-bezier(0.2, 0.0, 0, 1.0) forwards',
                        'thumb-pop': 'thumbPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        explode: {
                            '0%': { transform: 'scale(1)', opacity: '1' },
                            '50%': { transform: 'scale(1.5)', opacity: '0.8' },
                            '100%': { transform: 'scale(2)', opacity: '0' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(0)', opacity: '1' },
                            '100%': { transform: 'translateY(100%)', opacity: '0' }
                        },
                        thumbPop: {
                            '0%': { transform: 'scale(1) rotate(0deg)' },
                            '50%': { transform: 'scale(1.5) rotate(-15deg)' },
                            '100%': { transform: 'scale(1) rotate(0deg)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #030303;
            color: white;
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #030303; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4d4d4d; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #717171; 
        }

        .yt-btn {
            background: rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        .yt-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .artist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 24px;
        }
        
        @media (max-width: 768px) {
            .artist-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 16px;
            }
        }

        .discography-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 24px;
        }

        @media (max-width: 768px) {
            .discography-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 16px;
            }
        }

        /* Modal Animation */
        .modal {
            transition: opacity 0.25s ease;
            pointer-events: none;
            opacity: 0;
            backdrop-filter: blur(5px);
        }
        .modal.active {
            pointer-events: auto;
            opacity: 1;
        }
        .modal-content {
            transform: scale(0.95) translateY(20px);
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal.active .modal-content {
            transform: scale(1) translateY(0);
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Button Explode Effect */
        .icon-explode {
            position: relative;
        }
        .icon-explode::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            pointer-events: none;
        }
        .icon-explode.animating::after {
            animation: ripple 0.6s ease-out;
        }

        @keyframes ripple {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0.5; }
            100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; }
        }
        
        /* Mobile Nav */
        .mobile-nav-item.active {
            color: white;
        }
        .mobile-nav-item.active span {
            color: white;
        }
        .mobile-nav-item {
            color: #aaaaaa;
        }

        /* Sidebar Transition */
        aside {
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        aside.collapsed {
            width: 72px;
        }
        aside.collapsed .nav-text {
            display: none;
        }
        aside.collapsed .nav-btn {
            justify-content: center;
            padding-left: 0;
            padding-right: 0;
        }

        /* Toast positioning classes */
        .toast-hidden {
            transform: translateY(-150%); /* Move up for mobile */
        }
        @media (min-width: 768px) {
            .toast-hidden {
                transform: translateY(150%); /* Move down for desktop */
            }
        }
        
        /* Player Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            margin-top: -4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #4d4d4d;
            border-radius: 2px;
        }
        input[type=range]:hover::-webkit-slider-thumb {
            transform: scale(1.2);
        }

        /* Search Bar Animation */
        .search-container {
            transition: all 0.3s ease;
        }
        .search-container:focus-within {
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
            background-color: #121212;
            border-color: #444;
            flex-grow: 1.5;
        }
        .search-input {
            transition: width 0.3s ease;
        }

        /* Subscribe Thumbs Up Animation */
        .animate-thumb {
            animation: thumbPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
    </style>
</head>
<body class="h-screen flex flex-col bg-yt-base text-white">

    <!-- Desktop Top Navigation -->
    <nav class="h-16 flex items-center px-4 justify-between border-b border-[#1f1f1f] bg-[#030303] z-50 shrink-0">
        <div class="flex items-center gap-4">
            <button onclick="toggleSidebar()" class="p-2 rounded-full hover:bg-yt-hover hidden md:block icon-explode"><span class="material-icons-round text-white">menu</span></button>
            <div class="flex items-center gap-1 cursor-pointer" onclick="renderHome()">
                <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center">
                    <span class="material-icons-round text-yt-base text-xl">play_circle_filled</span>
                </div>
                <span class="text-xl font-bold tracking-tight hidden md:block">PeytoToria</span>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="flex flex-1 max-w-xl mx-4 transition-all duration-300 ease-in-out">
            <div class="search-container bg-[#212121] flex items-center w-full px-4 py-2 rounded-lg border border-[#303030] transition-all duration-300">
                <span class="material-icons-round text-yt-textSec">search</span>
                <input type="text" id="search-input" placeholder="Search artists, songs..." class="bg-transparent border-none outline-none text-white ml-2 w-full placeholder-gray-500" oninput="handleSearch(this.value)">
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-500 to-blue-500 text-white flex items-center justify-center font-bold text-sm shadow-lg">U</div>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden relative">
        <!-- Sidebar (Desktop) -->
        <aside id="sidebar" class="w-64 bg-[#030303] hidden md:flex flex-col p-2 overflow-y-auto border-r border-[#1f1f1f] shrink-0">
            <div class="flex flex-col gap-1">
                <button onclick="animateNav('nav-home', renderHome)" class="nav-btn flex items-center gap-4 px-4 py-3 rounded-lg hover:bg-[#1f1f1f] text-white font-medium transition icon-explode" id="nav-home">
                    <span class="material-icons-round">home</span> <span class="nav-text">Home</span>
                </button>
                <button onclick="animateNav('nav-explore', renderExplore)" class="nav-btn flex items-center gap-4 px-4 py-3 rounded-lg text-yt-textSec hover:text-white hover:bg-[#1f1f1f] font-medium transition icon-explode" id="nav-explore">
                    <span class="material-icons-round">explore</span> <span class="nav-text">Explore</span>
                </button>
                <button onclick="animateNav('nav-charts', renderCharts)" class="nav-btn flex items-center gap-4 px-4 py-3 rounded-lg text-yt-textSec hover:text-white hover:bg-[#1f1f1f] font-medium transition icon-explode" id="nav-charts">
                    <span class="material-icons-round">leaderboard</span> <span class="nav-text">Charts</span>
                </button>
                <button onclick="animateNav('nav-library', renderLibrary)" class="nav-btn flex items-center gap-4 px-4 py-3 rounded-lg text-yt-textSec hover:text-white hover:bg-[#1f1f1f] font-medium transition icon-explode" id="nav-library">
                    <span class="material-icons-round">library_music</span> <span class="nav-text">Library</span>
                </button>
            </div>
            
            <div class="mt-6 px-4 nav-text">
                <h3 class="text-xs uppercase font-bold text-yt-textSec mb-3">Your Artists</h3>
                <div id="sidebar-artist-list" class="flex flex-col gap-1">
                    <!-- Populated by JS -->
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-1 overflow-y-auto p-4 md:p-8 relative pb-32 md:pb-8">
            <!-- Content Injected Here -->
        </main>
    </div>

    <!-- Mobile Bottom Navigation -->
    <div class="md:hidden fixed bottom-0 left-0 right-0 h-16 bg-[#212121] border-t border-[#333] flex justify-around items-center z-50 pb-safe">
        <button onclick="animateNav('mob-nav-home', renderHome)" class="mobile-nav-item flex flex-col items-center gap-1 p-2 active icon-explode" id="mob-nav-home">
            <span class="material-icons-round">home</span>
            <span class="text-[10px]">Home</span>
        </button>
        <button onclick="animateNav('mob-nav-explore', renderExplore)" class="mobile-nav-item flex flex-col items-center gap-1 p-2 icon-explode" id="mob-nav-explore">
            <span class="material-icons-round">explore</span>
            <span class="text-[10px]">Explore</span>
        </button>
        <button onclick="animateNav('mob-nav-charts', renderCharts)" class="mobile-nav-item flex flex-col items-center gap-1 p-2 icon-explode" id="mob-nav-charts">
            <span class="material-icons-round">leaderboard</span>
            <span class="text-[10px]">Charts</span>
        </button>
        <button onclick="animateNav('mob-nav-library', renderLibrary)" class="mobile-nav-item flex flex-col items-center gap-1 p-2 icon-explode" id="mob-nav-library">
            <span class="material-icons-round">library_music</span>
            <span class="text-[10px]">Library</span>
        </button>
    </div>

    <!-- FULL SCREEN PLAYER -->
    <div id="music-player" class="fixed inset-0 z-[100] bg-[#030303] hidden flex flex-col h-[100dvh]">
        <!-- Background Gradient -->
        <div id="player-bg-gradient" class="absolute inset-0 bg-gradient-to-b from-[#1a1a1a] to-black opacity-95 pointer-events-none"></div>
        
        <!-- Top Bar -->
        <div class="relative z-10 flex items-center justify-between p-4 shrink-0">
            <button onclick="closePlayer()" class="p-2 text-white hover:bg-white/10 rounded-full transition"><span class="material-icons-round text-3xl">keyboard_arrow_down</span></button>
            <div class="text-xs uppercase tracking-widest text-gray-400 font-bold">Now Playing</div>
            <button class="p-2 text-white hover:bg-white/10 rounded-full transition"><span class="material-icons-round text-2xl">more_vert</span></button>
        </div>

        <!-- Main Content (Centered and responsive) -->
        <div class="relative z-10 flex-1 flex flex-col items-center justify-center w-full px-6 pb-8 overflow-hidden">
            
            <!-- Art Container (Responsive sizing - shrinks if needed) -->
            <div class="relative w-full max-w-sm md:max-w-md aspect-square shadow-2xl rounded-xl overflow-hidden mb-6 md:mb-10 flex-shrink min-h-0">
                <img id="player-img" src="" class="w-full h-full object-cover">
            </div>

            <!-- Metadata & Actions Row -->
            <div class="w-full max-w-2xl flex items-center justify-between mb-2 shrink-0">
                <div class="flex flex-col min-w-0 pr-4">
                    <h2 id="player-title" class="text-2xl md:text-3xl font-bold text-white truncate leading-tight">Song Title</h2>
                    <p id="player-artist" class="text-lg text-gray-400 truncate">Artist Name</p>
                </div>
                <!-- Like/Dislike Actions -->
                <div class="flex items-center gap-4 flex-shrink-0">
                     <button class="text-gray-400 hover:text-white transition"><span class="material-icons-round text-2xl">thumb_down</span></button>
                     <div class="flex flex-col items-center">
                        <button class="text-white hover:text-gray-200 transition"><span class="material-icons-round text-2xl">thumb_up</span></button>
                        <span id="player-likes" class="text-[10px] text-gray-400 font-medium mt-0.5">0</span>
                    </div>
                </div>
            </div>

             <!-- View Count (Subtle) -->
             <div class="w-full max-w-2xl text-xs text-gray-500 mb-6 flex items-center gap-1 shrink-0">
                <span id="player-views">0</span> views
             </div>

            <!-- Progress Bar -->
            <div class="w-full max-w-2xl mb-4 shrink-0 group">
                <input type="range" id="player-seek" value="0" min="0" max="100" class="w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer hover:h-1.5 transition-all accent-white">
                <div class="flex justify-between text-xs text-gray-400 mt-2 font-medium">
                    <span id="player-time-current">0:00</span>
                    <span id="player-time-total">0:00</span>
                </div>
            </div>

            <!-- Main Controls -->
            <div class="w-full max-w-2xl flex items-center justify-between shrink-0 px-2 md:px-8">
                <button class="text-gray-400 hover:text-white transition"><span class="material-icons-round text-2xl">shuffle</span></button>
                
                <div class="flex items-center gap-6 md:gap-10">
                    <button id="player-prev" class="text-white hover:text-gray-300 transition active:scale-90"><span class="material-icons-round text-4xl md:text-5xl">skip_previous</span></button>
                    
                    <button id="player-play-btn" onclick="togglePlay()" class="w-16 h-16 md:w-20 md:h-20 bg-white text-black rounded-full flex items-center justify-center hover:scale-105 transition shadow-lg active:scale-95">
                        <span class="material-icons-round text-4xl md:text-5xl" id="player-play-icon">play_arrow</span>
                    </button>
                    
                    <button id="player-next" class="text-white hover:text-gray-300 transition active:scale-90"><span class="material-icons-round text-4xl md:text-5xl">skip_next</span></button>
                </div>
                
                <button class="text-gray-400 hover:text-white transition"><span class="material-icons-round text-2xl">repeat</span></button>
            </div>
        </div>

        <!-- Hidden Audio Element -->
        <audio id="audio-element"></audio>
    </div>

    <!-- About Modal -->
    <div id="about-modal" class="modal fixed inset-0 z-[80] bg-black/80 flex items-center justify-center p-4">
        <div class="modal-content bg-[#212121] w-full max-w-2xl rounded-xl shadow-2xl overflow-hidden border border-[#333]">
            <div class="p-4 border-b border-[#333] flex justify-between items-center">
                <h2 class="text-xl font-bold">About Artist</h2>
                <button onclick="closeModal('about-modal')" class="text-gray-400 hover:text-white"><span class="material-icons-round">close</span></button>
            </div>
            <div class="p-8" id="about-modal-content">
                <!-- Injected via JS -->
            </div>
        </div>
    </div>

    <script>
        // --- STATE & STORAGE ---
        let state = {
            artists: [],
            releases: [],
            library: [],
        };

        let playerState = {
            isPlaying: false,
            currentReleaseId: null,
            currentTrackIndex: 0,
            audioUrl: null,
            release: null,
            track: null
        };

        const audioElement = document.getElementById('audio-element');

        const formatNumber = (num) => {
            if (num === undefined || num === null) return "0";
            if (!isFinite(num)) return "0";
            if (isNaN(num)) return "0";
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        };

        // --- INIT ---
        function init() {
            // Always seed the hardcoded data to ensure consistency "for everyone"
            // We do NOT load from local storage for the core data structure to enforce the mandate.
            // Local storage can be used for user preferences (like library), but here we force the state.
            seedLucidPP(); 

            renderHome();
            updateSidebar();
            
            // Audio Listeners
            audioElement.addEventListener('timeupdate', () => {
                const current = audioElement.currentTime;
                const duration = audioElement.duration || 0;
                document.getElementById('player-seek').value = (current / duration) * 100 || 0;
                document.getElementById('player-time-current').innerText = formatTime(current);
                document.getElementById('player-time-total').innerText = formatTime(duration);
            });
            audioElement.addEventListener('ended', playNext);
            
            document.getElementById('player-seek').addEventListener('input', (e) => {
                const percent = e.target.value;
                const duration = audioElement.duration;
                if(duration) audioElement.currentTime = (percent / 100) * duration;
            });
        }

        // --- CORE SEED LOGIC (HARDCODED FOR CONSISTENCY) ---
        function seedLucidPP() {
            const artistId = "lucidpp_id";
            
            // 1. Create Artist
            const artist = {
                id: artistId,
                name: "LucidPP",
                pfp: "https://ui-avatars.com/api/?name=LucidPP&background=000&color=fff&size=200", 
                banner: "LucidPPMNM.JPG", // Hardcoded per request
                bio: "Official Verified Artist.",
                subscribers: 2300,
                monthlyListeners: 103000,
                totalViews: 0, 
                pronouns: "He/Him",
                isVerified: true
            };

            // 2. Define Tracks with SPECIFIC HARDCODED VIEWS
            // These numbers are fixed constants in the code, ensuring every user sees the same thing.
            const trackDefs = [
                { file: "Down_Bad.mp3", views: 1245678 },
                { file: "All_By_Myself.mp3", views: 987654 },
                { file: "Your_Gonna_See.mp3", views: 876543 },
                { file: "Your_Gonna_See (1).mp3", views: 750000 },
                { file: "Honestly (1).mp3", views: 1100000 },
                { file: "Want_Me.mp3", views: 1350000 },
                { file: "Want_Me (1).mp3", views: 800000 },
                { file: "Want_Me (2).mp3", views: 790000 },
                { file: "Want_Me (3).mp3", views: 780000 },
                { file: "Want_Me (4).mp3", views: 770000 },
                { file: "Bells_PT1.mp3", views: 1050000 },
                { file: "To_Go_Back (1).mp3", views: 920000 },
                { file: "Laugh (1).mp3", views: 850000 },
                { file: "Demon_Girl (1).mp3", views: 1400000 },
                { file: "I_Messed_Up.mp3", views: 1150000 },
                { file: "Money_N_Money_Intro.mp3", views: 1200000 },
                { file: "Money_N_Money_Intro (1).mp3", views: 728000 }
            ];

            const tracksData = trackDefs.map(def => {
                return {
                    title: def.file.replace(/_/g, " ").replace(".mp3", ""),
                    filename: def.file, 
                    views: def.views, // Use the hardcoded value
                    duration: "3:30", 
                    weight: 1 
                };
            });

            const totalViews = tracksData.reduce((acc, t) => acc + t.views, 0);
            artist.totalViews = totalViews;

            // 3. Create Release
            const release = {
                id: "mnm_album_id",
                artistId: artistId,
                title: "Money N' Money",
                type: "Album",
                cover: "LucidPPMNM.JPG",
                tracks: tracksData.length,
                tracksData: tracksData,
                totalViews: totalViews,
                releaseTimestamp: Date.now()
            };

            state.artists = [artist];
            state.releases = [release];
            
            // Check for saved library state only
            const savedData = localStorage.getItem('peyza_sim_save');
            if (savedData) {
                const parsed = JSON.parse(savedData);
                if(parsed.library) state.library = parsed.library;
            }
        }

        function formatTime(seconds) {
            if(isNaN(seconds)) return "0:00";
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }

        // --- PLAYER LOGIC ---

        function trackClicked(releaseId, trackIndex) {
            const release = state.releases.find(r => r.id === releaseId);
            const track = release.tracksData[trackIndex];
            
            // Set audio source to the filename directly (relative path)
            const audioSrc = track.filename; 
            
            loadAndPlay(releaseId, trackIndex, audioSrc);
        }

        function loadAndPlay(releaseId, trackIndex, url) {
            const release = state.releases.find(r => r.id === releaseId);
            if (!release) return;

            playerState.currentReleaseId = releaseId;
            playerState.currentTrackIndex = trackIndex;
            playerState.release = release;
            playerState.track = release.tracksData[trackIndex];
            playerState.audioUrl = url;
            playerState.isPlaying = true;

            audioElement.src = url;
            
            const playPromise = audioElement.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log("Auto-play prevented or file not found.");
                });
            }

            openPlayer();
            updatePlayerUI();
        }

        function updatePlayerUI() {
            const { release, track } = playerState;
            const artist = state.artists.find(a => a.id === release.artistId);

            document.getElementById('player-title').innerText = track.title;
            document.getElementById('player-artist').innerText = artist.name;
            document.getElementById('player-img').src = release.cover;
            
            updatePlayerUIStats();
            updatePlayButton();
        }

        function updatePlayerUIStats() {
            if(!playerState.track) return;
            const track = playerState.track;
            // Fake likes based on views
            const likes = Math.floor(track.views * 0.04);
            
            document.getElementById('player-views').innerText = formatNumber(track.views);
            document.getElementById('player-likes').innerText = formatNumber(likes);
        }

        function togglePlay() {
            if (audioElement.paused) {
                audioElement.play();
                playerState.isPlaying = true;
            } else {
                audioElement.pause();
                playerState.isPlaying = false;
            }
            updatePlayButton();
        }

        function updatePlayButton() {
            const icon = document.getElementById('player-play-icon');
            icon.innerText = playerState.isPlaying ? 'pause' : 'play_arrow';
        }

        function openPlayer() {
            const p = document.getElementById('music-player');
            p.classList.remove('hidden');
            p.classList.add('animate-slide-up');
            p.classList.remove('animate-slide-down');
        }

        function closePlayer() {
            const p = document.getElementById('music-player');
            p.classList.add('animate-slide-down');
            p.classList.remove('animate-slide-up');
            setTimeout(() => {
                p.classList.add('hidden');
            }, 300);
        }

        function playNext() {
            if (playerState.currentTrackIndex < playerState.release.tracksData.length - 1) {
                const nextIdx = playerState.currentTrackIndex + 1;
                const nextTrack = playerState.release.tracksData[nextIdx];
                loadAndPlay(playerState.currentReleaseId, nextIdx, nextTrack.filename);
            } else {
                playerState.isPlaying = false;
                updatePlayButton();
            }
        }

        // --- RENDERERS ---

        function renderHome() {
            const main = document.getElementById('main-content');
            main.dataset.view = 'home';
            main.dataset.viewId = '';
            updateNavState('home');
            
            const release = state.releases[0];
            const artist = state.artists[0];

            main.innerHTML = `
                <div class="space-y-8 pb-20 animate-fade-in">
                    <section>
                        <h2 class="text-2xl font-bold mb-4">Quick Picks</h2>
                        <div class="bg-[#212121] p-4 rounded-lg flex items-center gap-4 cursor-pointer hover:bg-[#333] transition" onclick="renderRelease('${release.id}')">
                            <img src="${release.cover}" class="w-16 h-16 rounded object-cover">
                            <div>
                                <h3 class="font-bold text-white">${release.title}</h3>
                                <p class="text-sm text-yt-textSec">${artist.name} • Album</p>
                            </div>
                        </div>
                    </section>
                    
                    <section>
                        <h2 class="text-2xl font-bold mb-4">Your Favorites</h2>
                        <div class="artist-grid">
                            ${state.artists.map(artist => `
                                <div onclick="renderArtist('${artist.id}')" class="group cursor-pointer p-4 rounded-md hover:bg-[#1f1f1f] transition">
                                    <div class="relative mb-4">
                                        <img src="${artist.pfp}" class="w-full aspect-square object-cover rounded-full shadow-lg group-hover:scale-105 transition duration-300">
                                        <div class="absolute bottom-2 right-2 w-10 h-10 bg-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition shadow-xl">
                                            <span class="material-icons-round text-black">play_arrow</span>
                                        </div>
                                    </div>
                                    <h3 class="font-bold text-white truncate">${artist.name}</h3>
                                    <p class="text-sm text-yt-textSec">Artist</p>
                                </div>
                            `).join('')}
                        </div>
                    </section>
                </div>
            `;
        }
        
        function renderExplore() {
             const main = document.getElementById('main-content');
             main.innerHTML = `<div class="p-8 text-center text-gray-500">Explore is curated for LucidPP.</div>`;
             updateNavState('explore');
        }
        
        function renderCharts() {
             const main = document.getElementById('main-content');
             main.innerHTML = `<div class="p-8 text-center text-gray-500">LucidPP is #1 on all charts.</div>`;
             updateNavState('charts');
        }

        function renderLibrary() {
            const main = document.getElementById('main-content');
            main.dataset.view = 'library';
            updateNavState('library');

            const libraryArtists = state.artists.filter(a => state.library.includes(a.id));

            main.innerHTML = `
                <div class="space-y-8 pb-20 animate-fade-in">
                    <h1 class="text-4xl font-bold mb-6">Your Library</h1>
                    ${libraryArtists.length === 0 ? 
                        `<div class="text-center text-gray-500 py-20">
                            <span class="material-icons-round text-6xl mb-4">library_music</span>
                            <p>You haven't subscribed to anyone yet.</p>
                        </div>` 
                    : 
                        `<div class="artist-grid">
                            ${libraryArtists.map(artist => `
                                <div onclick="renderArtist('${artist.id}')" class="group cursor-pointer p-4 rounded-md hover:bg-[#1f1f1f] transition">
                                    <img src="${artist.pfp}" class="w-full aspect-square object-cover rounded-full mb-4 shadow-lg">
                                    <h3 class="font-bold text-white truncate">${artist.name}</h3>
                                    <p class="text-sm text-yt-textSec">Subscribed</p>
                                </div>
                            `).join('')}
                        </div>`
                    }
                </div>
            `;
        }

        function renderArtist(id) {
            const artist = state.artists.find(a => a.id === id);
            if (!artist) return;

            const main = document.getElementById('main-content');
            main.dataset.view = 'artist';
            main.dataset.viewId = id;
            updateNavState('');
            
            const isSubscribed = state.library.includes(id);
            const artistReleases = state.releases.filter(r => r.artistId === id);
            
            // Sort tracks by views for "Top Songs"
            // Use spread syntax to avoid mutating original order in release
            let allTracks = [];
            artistReleases.forEach(r => {
                r.tracksData.forEach((t, idx) => {
                    allTracks.push({ ...t, release: r, index: idx });
                });
            });
            const topSongs = [...allTracks].sort((a,b) => b.views - a.views).slice(0, 5);

            main.innerHTML = `
                <div class="pb-20 animate-fade-in">
                    <!-- Banner -->
                    <div class="relative w-full h-64 md:h-80 rounded-t-xl overflow-hidden mb-6 group">
                        <img src="${artist.banner}" class="w-full h-full object-cover brightness-75">
                        <div class="absolute inset-0 bg-gradient-to-t from-[#030303] via-transparent to-transparent"></div>
                        
                        <div class="absolute bottom-8 left-8">
                            <div class="flex items-center gap-2 mb-2">
                                <h1 class="text-4xl md:text-7xl font-black tracking-tighter shadow-xl">${artist.name}</h1>
                                <span class="material-icons-round text-blue-400 text-3xl" title="Verified">verified</span>
                            </div>
                            
                            <div class="flex items-center gap-2 text-sm font-medium text-gray-200 mb-4">
                                <span>${formatNumber(artist.monthlyListeners)} monthly listeners</span>
                                <span class="w-1 h-1 bg-gray-400 rounded-full mx-1"></span>
                                <span>${artist.pronouns}</span>
                            </div>

                            <div class="flex items-center gap-4 mt-6">
                                <button onclick="toggleSubscribe('${artist.id}')" class="${isSubscribed ? 'bg-[#212121] text-white border border-[#333]' : 'bg-white text-black'} px-6 md:px-8 py-2 md:py-3 rounded-full font-bold uppercase tracking-wide hover:bg-gray-200 hover:text-black transition text-sm flex items-center gap-2">
                                    <span id="sub-icon-${artist.id}" class="material-icons-round text-lg">${isSubscribed ? 'thumb_up' : 'thumb_up_off_alt'}</span>
                                    <span>${isSubscribed ? 'Subscribed' : 'Subscribe'}</span>
                                    <span class="opacity-70 text-xs">• ${formatNumber(artist.subscribers)}</span>
                                </button>
                                <button class="bg-[#212121]/80 backdrop-blur-md border border-white/20 text-white px-4 py-2 md:py-3 rounded-full font-bold hover:bg-[#333] transition flex items-center gap-2 text-sm">
                                    <span class="material-icons-round">radio</span> Radio
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 space-y-8">
                            <section>
                                <h2 class="text-2xl font-bold mb-4">Top Songs</h2>
                                <div class="flex flex-col">
                                    ${topSongs.map((song, i) => `
                                        <div onclick="trackClicked('${song.release.id}', ${song.index})" class="flex items-center gap-4 p-3 rounded hover:bg-[#1f1f1f] group cursor-pointer transition">
                                            <span class="text-gray-400 w-4 text-center font-medium">${i + 1}</span>
                                            <img src="${song.release.cover}" class="w-12 h-12 rounded object-cover">
                                            <div class="flex-1 min-w-0">
                                                <div class="font-medium text-white truncate">${song.title}</div>
                                                <div class="text-sm text-gray-400">${formatNumber(song.views)} views • ${song.release.title}</div>
                                            </div>
                                            <div class="text-sm text-gray-400 mr-4">Play</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </section>

                            <section>
                                <h2 class="text-2xl font-bold mb-4">Discography</h2>
                                <div class="discography-grid">
                                    ${artistReleases.map(r => getReleaseCard(r)).join('')}
                                </div>
                            </section>
                        </div>

                        <div class="lg:col-span-1 space-y-8">
                            <section>
                                <h2 class="text-2xl font-bold mb-4">About</h2>
                                <div onclick="openAboutModal('${artist.id}')" class="relative rounded-lg overflow-hidden group cursor-pointer hover:ring-2 ring-white/20 transition">
                                    <div class="bg-[#1f1f1f] p-6 min-h-[200px] flex flex-col justify-end">
                                        <p class="text-white line-clamp-3 mb-4 font-serif italic">"${artist.bio}"</p>
                                        <div class="text-sm text-gray-400 flex justify-between items-end">
                                             <div>
                                                <div class="text-white font-bold text-lg">${formatNumber(artist.totalViews)}</div>
                                                <div>Total Career Views</div>
                                             </div>
                                             <div class="bg-gray-800 p-2 rounded-full hover:bg-gray-700 transition">
                                                <span class="material-icons-round text-white">arrow_forward</span>
                                             </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderRelease(releaseId) {
            const release = state.releases.find(r => r.id === releaseId);
            if (!release) return;

            const main = document.getElementById('main-content');
            main.dataset.view = 'release';
            main.dataset.viewId = releaseId;
            updateNavState('');

            const artist = state.artists.find(a => a.id === release.artistId);
            
            main.innerHTML = `
                 <div class="pb-20 max-w-7xl mx-auto animate-fade-in">
                    <div class="flex flex-col md:flex-row gap-8 mb-8">
                        <div class="w-full md:w-72 flex-shrink-0">
                            <img src="${release.cover}" class="w-full aspect-square object-cover rounded shadow-2xl">
                        </div>
                        <div class="flex flex-col justify-end">
                            <h2 class="text-4xl md:text-5xl font-black mb-4">${release.title}</h2>
                            <div class="flex items-center gap-2 mb-4">
                                <img src="${artist.pfp}" class="w-6 h-6 rounded-full">
                                <span class="font-bold text-white hover:underline cursor-pointer" onclick="renderArtist('${artist.id}')">${artist.name}</span>
                            </div>
                            <div class="text-gray-400 text-sm flex gap-4 items-center">
                                <span>${release.type}</span>
                                <span>•</span>
                                <span class="flex items-center gap-1"><span class="material-icons-round text-sm">visibility</span> ${formatNumber(release.totalViews)}</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-[#030303]">
                         <div class="border-b border-[#1f1f1f] text-gray-400 text-sm py-2 px-4 grid grid-cols-[auto_1fr_auto] gap-4 mb-2">
                            <span>#</span>
                            <span>Title</span>
                            <span class="flex items-center gap-2"><span class="material-icons-round text-sm">visibility</span> Views</span>
                        </div>
                        <div class="flex flex-col">
                            ${release.tracksData.map((track, i) => `
                                <div onclick="trackClicked('${release.id}', ${i})" class="grid grid-cols-[auto_1fr_auto] gap-4 py-3 px-4 hover:bg-[#1f1f1f] rounded group items-center cursor-pointer transition">
                                    <div class="w-6 text-center text-gray-400 group-hover:hidden">${i + 1}</div>
                                    <div class="w-6 text-center hidden group-hover:block"><span class="material-icons-round text-white text-sm">play_arrow</span></div>
                                    <div class="flex flex-col">
                                        <span class="text-white font-medium">${track.title}</span>
                                        <span class="text-gray-500 text-xs">${artist.name}</span>
                                    </div>
                                    <div class="text-gray-400 text-sm flex items-center gap-8">
                                        <span>${formatNumber(track.views)}</span>
                                        <span>${track.duration}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- HELPER COMPONENTS ---

        function getReleaseCard(release) {
             const artist = state.artists.find(a => a.id === release.artistId);
             
             return `
                <div onclick="renderRelease('${release.id}')" class="cursor-pointer group">
                    <div class="relative mb-3 overflow-hidden rounded-md">
                        <img src="${release.cover}" class="w-full aspect-square object-cover group-hover:opacity-80 transition">
                    </div>
                    <h3 class="font-medium text-white truncate">${release.title}</h3>
                    <p class="text-sm text-yt-textSec truncate">${artist.name} • ${release.type}</p>
                </div>
            `;
        }

        function openAboutModal(id) {
            const artist = state.artists.find(a => a.id === id);
            const content = document.getElementById('about-modal-content');
            content.innerHTML = `
                <div class="flex gap-4 mb-6">
                    <img src="${artist.pfp}" class="w-24 h-24 rounded-full object-cover">
                    <div>
                        <h3 class="text-2xl font-bold">${artist.name}</h3>
                        <div class="text-gray-400">${formatNumber(artist.subscribers)} Subscribers</div>
                    </div>
                </div>
                <div class="bg-[#121212] p-4 rounded mb-4 text-sm leading-relaxed text-gray-300">${artist.bio}</div>
            `;
            openModal('about-modal');
        }

        function updateSidebar() {
            const list = document.getElementById('sidebar-artist-list');
            list.innerHTML = state.artists.map(a => `
                <div onclick="renderArtist('${a.id}')" class="flex items-center gap-3 p-2 rounded-md hover:bg-[#1f1f1f] cursor-pointer transition">
                    <img src="${a.pfp}" class="w-8 h-8 rounded-full object-cover">
                    <div class="flex-1 min-w-0 nav-text">
                        <div class="text-sm font-medium text-white truncate">${a.name}</div>
                        <div class="text-xs text-yt-textSec">Artist</div>
                    </div>
                </div>
            `).join('');
        }

        function handleSearch(query) {
            if (!query) {
                renderHome();
                return;
            }
            // Simple search for LucidPP
            if("LucidPP".toLowerCase().includes(query.toLowerCase())) {
                renderArtist(state.artists[0].id);
            }
        }

        // --- UTILS ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        function animateNav(id, callback) {
            const btn = document.getElementById(id);
            if (btn) {
                btn.classList.remove('animating');
                void btn.offsetWidth; 
                btn.classList.add('animating');
            }
            callback();
        }
        
        function updateNavState(view) {
            ['nav-home', 'nav-explore', 'nav-charts', 'nav-library'].forEach(id => {
                const btn = document.getElementById(id);
                if (id === 'nav-'+view) {
                    btn.classList.add('bg-[#1f1f1f]', 'text-white');
                    btn.classList.remove('text-yt-textSec');
                } else {
                    btn.classList.remove('bg-[#1f1f1f]', 'text-white');
                    btn.classList.add('text-yt-textSec');
                }
            });
             ['mob-nav-home', 'mob-nav-explore', 'mob-nav-charts', 'mob-nav-library'].forEach(id => {
                const btn = document.getElementById(id);
                if (id === 'mob-nav-'+view) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function openModal(id) {
            const modal = document.getElementById(id);
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            modal.classList.remove('active');
            setTimeout(() => modal.classList.add('hidden'), 250);
        }

        // --- DATA PERSISTENCE ---

        function saveToLocal() {
            try {
                localStorage.setItem('peyza_sim_save', JSON.stringify(state));
            } catch (e) {
                console.warn("Save failed");
            }
        }

        function loadFromLocal() {
            const data = localStorage.getItem('peyza_sim_save');
            if (data) {
                // We load saved data (like library/subscribers state)
                // BUT we ensure the track view counts are reset to hardcoded values
                const savedState = JSON.parse(data);
                
                // Keep library
                if(savedState.library) state.library = savedState.library;
            }
            // Always run seed to enforce track views
            seedLucidPP();
        }

        function downloadSave() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "peyza_save.json");
            document.body.appendChild(downloadAnchorNode); 
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function uploadSave(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    state = JSON.parse(e.target.result);
                    saveToLocal();
                    location.reload(); 
                } catch (err) {
                    alert("Invalid Save File");
                }
            };
            reader.readAsText(file);
        }

        function resetData() {
            if(confirm("Resetting will restore LucidPP defaults. Continue?")) {
                localStorage.removeItem('peyza_sim_save');
                location.reload();
            }
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target.id);
            }
        }

        init();
    </script>
</body>
</html>
